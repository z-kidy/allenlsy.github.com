<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C Essense (3) - Linkage &mdash; Simple, Not Easy</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700,800|Oswald|PT+Mono|Ubuntu+Mono" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.jpg"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Simple, Not Easy" />
    <meta name="title" content="C Essense (3) - Linkage ">
    <link rel="canonical" href="/c-essence-3">
    
    <link rel="author" href="https://plus.google.com/118230970865161551961">
    <meta property="og:title" content="C Essense (3) - Linkage "/>
    <meta property="og:url" content="/c-essence-3"/>
    
    <meta property="og:image" content="/images/cppcafe.jpg"/>
    
    <meta property="og:image" content="/images/logo.jpg"/>
    
    
    <meta property="og:site_name" content="Simple, Not Easy">
    <link rel="stylesheet" href="/bt-responsive.css" type="text/css" media="screen" charset="utf-8">
    <meta name="keywords" content="c">
</head>
<body>

<section class="site-nav">
    <header>
        <nav id="navigation" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
            <a class="brand" href="/">
                <img src="/images/logo.jpg" alt="Inc">
            </a>
            <a href="/">Blog</a>
            
              <a href="/archives.html" >Archives</a>
            
              <a href="/about.html" >About</a>
            
              <a href="/tags.html" >Tags</a>
            
              <a href="http://cast.allenlsy.com" >Casts</a>
            
            <i class="icon-feed"></i> <a href="/feed.xml" title="Atom/RSS feed">Feed</a>
        </nav>

    </header>
</section>


<div class="article-cover">
    <div>
        <img src="/images/cppcafe.jpg" class="image">
    </div>
</div>

<article>

    <div class="container">
        <header>
            <h1 class="title">C Essense (3) - Linkage</h1>
            
            <div class="meta">
                <time pubdate datetime="2013-19-May" title="May 19, 2013">May 19, 2013</time>
            </div>
            <div class="tags">
              <a href="/tags/c.html" rel="tag">c</a>
            </div>
            <div class="hidden-seo">
              By <a href="/c-essence-3" title="C Essense (3) - Linkage" rel="author">allenlsy</a>
            </div>
        </header>

        <section class="article">
            <blockquote>
  <p>The source code was tested and passed in <a href="http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130309.box">CentOS 6.4 vagrant box</a>
Github repository: <a href="http://github.com/allenlsy/c_essence">http://github.com/allenlsy/c_essence</a></p>
</blockquote>

<ul>
  <li><a href="#i1">1. Link multiple target file</a></li>
  <li><a href="#i2">2. Definition and Declaration</a>
    <ul>
      <li><a href="#i2_1">2.1 <code>extern</code> and <code>static</code> keyword</a></li>
      <li><a href="#i2_2">2.2 Header file</a></li>
    </ul>
  </li>
  <li><a href="#i3">3. Static library</a></li>
  <li><a href="#i4">4. Shared library</a>
    <ul>
      <li><a href="#i4_1">4.1 Without <code>-fPIC</code> option</a></li>
      <li><a href="#i4_2">4.2 With <code>-fPIC</code> option</a></li>
      <li><a href="#i4_3">4.3 Dynamic linking</a></li>
      <li><a href="#i4_4">4.4 Shared library naming convention</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="i1">1. Link multiple target file</h2>

<p>We use a stack program as an example.</p>

<div class="highlight"><pre><code class="cpp"><span class="c1">// stack.c</span>
<span class="kt">char</span> <span class="n">stack</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">top</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">push</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stack</span><span class="p">[</span><span class="o">++</span><span class="n">top</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="nf">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">top</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">top</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><code class="cpp"><span class="c1">// main.c</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">);</span>
	
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">is_empty</span><span class="p">())</span>
		<span class="n">putchar</span><span class="p">(</span><span class="n">pop</span><span class="p">());</span>
	<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Compile them together. <code>gcc main.c stack.c -o main</code></p>

<p>Use <code>nm</code> to check the label table.</p>

<h2 id="i2">2. Definition and Declaration</h2>

<h3 id="i2_1">2.1 <code>extern</code> and <code>static</code> keyword</h3>

<p>During the compilation, the order of <code>main.c</code> and <code>stack.c</code> matters. </p>

<p>If we compile <code>main.c</code> separately, with <code>-Wall</code> option, <code>gcc -c main.c -Wall</code>, we find a warning.</p>

<pre><code>$ gcc -c main.c -Wall

main.c: In function ‘main’:
main.c:7: warning: implicit declaration of function ‘push’
main.c:11: warning: implicit declaration of function ‘is_empty’
main.c:12: warning: implicit declaration of function ‘pop’
</code></pre>

<p>Compiler cannot find the function prototype, therefore it create implicit declaration.</p>

<div class="highlight"><pre><code class="cpp"><span class="kt">int</span> <span class="nf">push</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></div>

<p>But we should not depend on implicit declaration, because it may make mistake.</p>

<p>To eliminate the warning:</p>

<div class="highlight"><pre><code class="cpp"><span class="c1">// main.c</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">posh</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="nf">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">);</span>
	
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">is_empty</span><span class="p">())</span>
		<span class="n">putchar</span><span class="p">(</span><span class="n">pop</span><span class="p">());</span>
	<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><code>extern</code> keyword of <code>push</code> means, <code>push</code> will be defined with external linkage. And if we don’t write <code>extern</code>, it still have external linkage.</p>

<p>If a function is <code>static</code>, then it has static linkage. It will only be recognised within the file.</p>

<p>Now, if from <code>main.c</code>, I want to access <code>top</code> in <code>stack.c</code>, just add a line <code>extern int top;</code>. Since <code>top</code> already has the external linkage, it will be linked correctly.</p>

<div class="highlight"><pre><code class="cpp"><span class="c1">// main.c</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">posh</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="nf">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">);</span>
	
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">top</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">top</span><span class="p">);</span>
	
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">is_empty</span><span class="p">())</span>
		<span class="n">putchar</span><span class="p">(</span><span class="n">pop</span><span class="p">());</span>
	<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>But for a stack, it should hide <code>top</code> variable. </p>

<div class="highlight"><pre><code class="cpp"><span class="c1">// stack.c</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">stack</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">top</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">push</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stack</span><span class="p">[</span><span class="o">++</span><span class="n">top</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="nf">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">top</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">top</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="i2_2">2.2 Header file</h3>

<p>Header file is used for recursively including module. Let’s make a header file for stack.</p>

<div class="highlight"><pre><code class="cpp"><span class="c1">// stack.h</span>
<span class="cp">#ifndef STACK_H</span>
<span class="cp">#define STACK_H</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">push</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="nf">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>
</code></pre></div>

<p>Then in <code>main.c</code>, we only need to include <code>stack.h</code>, without declare three extern method prototypes.</p>

<div class="highlight"><pre><code class="cpp"><span class="c1">// main.c</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &quot;stack.h&quot;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">);</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">);</span>
	
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">is_empty</span><span class="p">())</span>
		<span class="n">putchar</span><span class="p">(</span><span class="n">pop</span><span class="p">());</span>
	<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Headers included using <code>&lt;&gt;</code>, gcc will look for them in the order of:</p>

<ul>
  <li>folders that <code>-I</code> option assigns</li>
  <li>system header files, usually in <code>/usr/include</code></li>
</ul>

<p>Headers included using <code>""</code>, gcc will look for them in the order of:</p>

<ul>
  <li>current folder</li>
  <li>folders that <code>-I</code> option assigns</li>
  <li>system header files</li>
</ul>

<h4 id="example-1">Example 1</h4>

<p>Suppose we have a folder structure like this:</p>

<p>$ tree</p>

<pre><code>.
├── main.c
└── stack
    ├── stack.c
    └── stack.h

1 directory, 3 files
</code></pre>

<p>Use <code>gcc -c main.c -Istack</code> to compile. <code>-I</code> tells gcc to look for headers in <em>stack</em> folder.</p>

<p><strong>Header guard</strong> protects including headers repeatedly. The main reason is that some kinds of code, like <code>typedef</code>, should not be defined multiple times.</p>

<blockquote>
  <p>An important concept <strong>Previous linkage</strong> of a label: the same type of linkage as last time.</p>
</blockquote>

<h2 id="i3">3. Static library</h2>

<p><code>libc</code> is a static library.</p>

<p>To illustrate how to create a static library file, we separate <code>stack.c</code> into four files.</p>

<div class="highlight"><pre><code class="cpp"><span class="cm">/* stack.c */</span>
<span class="kt">char</span> <span class="n">stack</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">top</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* push.c */</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">stack</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">top</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">push</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">stack</span><span class="p">[</span><span class="o">++</span><span class="n">top</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pop.c */</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">stack</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">top</span><span class="p">;</span>

<span class="kt">char</span> <span class="nf">pop</span><span class="p">(</span><span class="n">voi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">stack</span><span class="p">[</span><span class="n">top</span><span class="o">--</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* is_empty.c */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">top</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">top</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* stack.h */</span>
<span class="cp">#ifndef STACK_H</span>
<span class="cp">#define STACK_H</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">push</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="nf">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">is_empty</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* main.c */</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &quot;stack.h&quot;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">push</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>The folder structure should be:</p>

<pre><code>.
├── main.c
└── stack
    ├── is_empty.c
    ├── pop.c
    ├── push.c
    ├── stack.c
    └── stack.h

1 directory, 6 files
</code></pre>

<p>Compile the whole project using <code>gcc -c stack/stack.c stack/push.c stack/pop.c stack/is_empty.c</code>.</p>

<p>Then create the static library file <code>libstack.a</code>:</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>ar rs libstack.a stack.o push.o pop.o is_empty.o

ar: creating libstack.a
</code></pre></div>

<p><code>ar</code> means archive, similar to <code>tar</code> command. Option <code>r</code> means replace existing file into archive. Option <code>s</code> means create static library, with static index. <code>ranlib</code> is another command for creating static index.</p>

<p>Now we can compile <code>main.c</code> with <code>libstack.a</code>, <code>gcc main.c -L. -lstack -Istack -o main</code></p>

<p><code>-L</code> option assigns the path of library files. <code>.</code> means current folder. This option is not optional. </p>

<p><code>-l</code> option tells the compiler to link <code>libstack</code></p>

<p><code>-I</code> option tells the compiler the path of header files</p>

<p>The default searching path for compile: <code>gcc -print-search-dirs</code></p>

<p>Compiler looks for library in the order of shared library and static library.</p>

<p><strong>Shared library</strong> will not be linked by linker. Linker just assign the dynamic linker for it and tells the require shared library file name. Static library will be compile and linked into the executable.</p>

<h2 id="i4">4. Shared library</h2>

<p>The files to composite a shared library are different than normal target files. It must use option <code>-fPIC</code> to compile them.</p>

<h3 id="i4_1">4.1 Without <code>-fPIC</code> option</h3>

<p>We can check the difference in the compiled <code>push.o</code> file.</p>

<pre><code>$ gcc -c -g stack/stack.c stack/push.c stack/pop.c stack/is_empty.c
$ objdump -dS push.o

push.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &lt;push&gt;:
   0:   55                      push   %rbp
   1:   48 89 e5                mov    %rsp,%rbp
   4:   89 f8                   mov    %edi,%eax
   6:   88 45 fc                mov    %al,-0x4(%rbp)
   9:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 10 &lt;push+0x10&gt;
  10:   8b 00                   mov    (%rax),%eax
  12:   8d 50 01                lea    0x1(%rax),%edx
  15:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 1c &lt;push+0x1c&gt;
  1c:   89 10                   mov    %edx,(%rax)
  1e:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 25 &lt;push+0x25&gt;
  25:   8b 00                   mov    (%rax),%eax
  27:   48 8b 15 00 00 00 00    mov    0x0(%rip),%rdx        # 2e &lt;push+0x2e&gt;
  2e:   48 98                   cltq   
  30:   0f b6 4d fc             movzbl -0x4(%rbp),%ecx
  34:   88 0c 02                mov    %cl,(%rdx,%rax,1)
  37:   c9                      leaveq 
  38:   c3                      retq   
</code></pre>

<p>The address of <code>stack</code> and <code>top</code> are 0x0. They will be modified during relocation.</p>

<pre><code>$ readelf -a push.o

...
Relocation section '.rela.text' at offset 0x598 contains 4 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
00000000000c  000a00000009 R_X86_64_GOTPCREL 0000000000000000 top - 4
000000000018  000a00000009 R_X86_64_GOTPCREL 0000000000000000 top - 4
000000000021  000a00000009 R_X86_64_GOTPCREL 0000000000000000 top - 4
00000000002a  000b00000009 R_X86_64_GOTPCREL 0000000000000000 stack - 4

Relocation section '.rela.eh_frame' at offset 0x5f8 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0
...
</code></pre>

<p>It says there are 4 things need to be modified during relocation.</p>

<p>Let’s link them to a executable file and then disassemble it.</p>

<pre><code>$ gcc -g main.c stack.o push.o pop.o is_empty.o -Istack -o main
$ objdump -dS main

...

000000000040050c &lt;push&gt;:
  40050c:       55                      push   %rbp
  40050d:       48 89 e5                mov    %rsp,%rbp
  400510:       89 f8                   mov    %edi,%eax
  400512:       88 45 fc                mov    %al,-0x4(%rbp)
  400515:       48 8b 05 4c 04 20 00    mov    0x20044c(%rip),%rax        # 600968 &lt;_DYNAMIC+0x198&gt;
  40051c:       8b 00                   mov    (%rax),%eax
  40051e:       8d 50 01                lea    0x1(%rax),%edx
  400521:       48 8b 05 40 04 20 00    mov    0x200440(%rip),%rax        # 600968 &lt;_DYNAMIC+0x198&gt;
  400528:       89 10                   mov    %edx,(%rax)
  40052a:       48 8b 05 37 04 20 00    mov    0x200437(%rip),%rax        # 600968 &lt;_DYNAMIC+0x198&gt;
  400531:       8b 00                   mov    (%rax),%eax
  400533:       48 8b 15 36 04 20 00    mov    0x200436(%rip),%rdx        # 600970 &lt;_DYNAMIC+0x1a0&gt;
  40053a:       48 98                   cltq   
  40053c:       0f b6 4d fc             movzbl -0x4(%rbp),%ecx
  400540:       88 0c 02                mov    %cl,(%rdx,%rax,1)
  400543:       c9                      leaveq 
  400544:       c3                      retq   
  400545:       90                      nop
  400546:       90                      nop
  400547:       90                      nop

...
</code></pre>

<p>All the 0x0 address are replaced with absolute addresses. This is <strong>Relocation</strong>.</p>

<h3 id="i4_2">4.2 With <code>-fPIC</code> option</h3>

<pre><code>$ gcc -c -g -fPIC stack/stack.c stack/push.c stack/pop.c stack/is_empty.c
$ objdump -dS push.o

push.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &lt;push&gt;:
extern char stack[512];
extern int top;

void push(char c) 
{
   0:   55                      push   %rbp
   1:   48 89 e5                mov    %rsp,%rbp
   4:   89 f8                   mov    %edi,%eax
   6:   88 45 fc                mov    %al,-0x4(%rbp)
    stack[++top] = c;
   9:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 10 &lt;push+0x10&gt;
  10:   8b 00                   mov    (%rax),%eax
  12:   8d 50 01                lea    0x1(%rax),%edx
  15:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 1c &lt;push+0x1c&gt;
  1c:   89 10                   mov    %edx,(%rax)
  1e:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 25 &lt;push+0x25&gt;
  25:   8b 00                   mov    (%rax),%eax
  27:   48 8b 15 00 00 00 00    mov    0x0(%rip),%rdx        # 2e &lt;push+0x2e&gt;
  2e:   48 98                   cltq   
  30:   0f b6 4d fc             movzbl -0x4(%rbp),%ecx
  34:   88 0c 02                mov    %cl,(%rdx,%rax,1)
}
  37:   c9                      leaveq 
  38:   c3                      retq   
</code></pre>

<p><code>stack</code> and <code>top</code> are no longer 0x0. They are <code>0x0(%rip)</code>. </p>

<pre><code>$ readelf -a push.o

...
Relocation section '.rela.text' at offset 0xb50 contains 4 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
00000000000c  001000000009 R_X86_64_GOTPCREL 0000000000000000 top - 4
000000000018  001000000009 R_X86_64_GOTPCREL 0000000000000000 top - 4
000000000021  001000000009 R_X86_64_GOTPCREL 0000000000000000 top - 4
00000000002a  001100000009 R_X86_64_GOTPCREL 0000000000000000 stack - 4
...
</code></pre>

<p>Create shared library.</p>

<pre><code>$ gcc -shared -o libstack.so stack.o push.o pop.o is_empty.o
$ objdump -dS libstack.so

...
00000000000005ec &lt;push&gt;:
extern char stack[512];
extern int top;

void push(char c) 
{
 5ec:   55                      push   %rbp
 5ed:   48 89 e5                mov    %rsp,%rbp
 5f0:   89 f8                   mov    %edi,%eax
 5f2:   88 45 fc                mov    %al,-0x4(%rbp)
    stack[++top] = c;
 5f5:   48 8b 05 24 03 20 00    mov    0x200324(%rip),%rax        # 200920 &lt;_DYNAMIC+0x190&gt;
 5fc:   8b 00                   mov    (%rax),%eax
 5fe:   8d 50 01                lea    0x1(%rax),%edx
 601:   48 8b 05 18 03 20 00    mov    0x200318(%rip),%rax        # 200920 &lt;_DYNAMIC+0x190&gt;
 608:   89 10                   mov    %edx,(%rax)
 60a:   48 8b 05 0f 03 20 00    mov    0x20030f(%rip),%rax        # 200920 &lt;_DYNAMIC+0x190&gt;
 611:   8b 00                   mov    (%rax),%eax
 613:   48 8b 15 16 03 20 00    mov    0x200316(%rip),%rdx        # 200930 &lt;_DYNAMIC+0x1a0&gt;
 61a:   48 98                   cltq   
 61c:   0f b6 4d fc             movzbl -0x4(%rbp),%ecx
 620:   88 0c 02                mov    %cl,(%rdx,%rax,1)
}
 623:   c9                      leaveq 
 624:   c3                      retq   
 625:   90                      nop
 626:   90                      nop
 627:   90                      nop

...
</code></pre>

<p>At 5f5, 0x200324 stores another address. That address is the address of <code>top</code>. This is called <strong>Indirect addressing</strong>.</p>

<p>Now compile and link <code>main.c</code> with <code>libstack.so</code>.</p>

<pre><code>$ gcc main.c -g -L. -lstack -Istack -o main
$ ./main

./main: error while loading shared libraries: libstack.so: cannot open shared object file: No such file or directory
</code></pre>

<p>Why can’t gcc find <code>libstack.so</code>? We can use <code>ldd</code> command to check which libraries the executable file depends on.</p>

<pre><code>$ ldd main

        linux-vdso.so.1 =&gt;  (0x00007fffe17f1000)
        libstack.so =&gt; not found
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fc962e17000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc9631b4000)
</code></pre>

<p>The searching order is decided by the dynamic linker. <code>man 8 ld.so</code> can see the searching order.</p>

<pre><code>   The shared libraries needed by the program are searched for in the following order:

   o  (ELF only) Using the directories specified in the DT_RPATH dynamic section attribute of the binary if present and DT_RUNPATH  attribute  does  not  exist.
      Use of DT_RPATH is deprecated.

   o  Using the environment variable LD_LIBRARY_PATH.  Except if the executable is a set-user-ID/set-group-ID binary, in which case it is ignored.

   o  (ELF only) Using the directories specified in the DT_RUNPATH dynamic section attribute of the binary if present.

   o  From  the  cache file /etc/ld.so.cache which contains a compiled list of candidate libraries previously found in the augmented library path.  If, however,
      the binary was linked with the -z nodeflib linker option, libraries in the default library paths are skipped.

   o  In the default path /lib, and then /usr/lib.  If the binary was linked with the -z nodeflib linker option, this step is skipped.
</code></pre>

<p>To summarise, <strong>the best way to solve the problem</strong>, is the second way described in the man page. </p>

<ul>
  <li>add current path to <code>/etc/ld.so.conf</code></li>
  <li><code>sudo ldconfig -v</code> to reconfig and shows all the shared library. </li>
  <li><code>ldd main</code> again</li>
</ul>

<p>Another way is to add <code>libstack.so</code> to system library. Usually <code>/usr/lib</code>.</p>

<h3 id="i4_3">4.3 Dynamic linking</h3>

<p>Let’s look into <code>main</code> to see how it call <code>push()</code> from the shared library.</p>

<pre><code>$ objdump -dS main

...
Disassembly of section .plt:

00000000004004a0 &lt;__libc_start_main@plt-0x10&gt;:
  4004a0:       ff 35 a2 04 20 00       pushq  0x2004a2(%rip)        # 600948 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;
  4004a6:       ff 25 a4 04 20 00       jmpq   *0x2004a4(%rip)        # 600950 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;
  4004ac:       0f 1f 40 00             nopl   0x0(%rax)

00000000004004b0 &lt;__libc_start_main@plt&gt;:
  4004b0:       ff 25 a2 04 20 00       jmpq   *0x2004a2(%rip)        # 600958 &lt;_GLOBAL_OFFSET_TABLE_+0x18&gt;
  4004b6:       68 00 00 00 00          pushq  $0x0
  4004bb:       e9 e0 ff ff ff          jmpq   4004a0 &lt;_init+0x18&gt;

00000000004004c0 &lt;push@plt&gt;:
  4004c0:       ff 25 9a 04 20 00       jmpq   *0x20049a(%rip)        # 600960 &lt;_GLOBAL_OFFSET_TABLE_+0x20&gt;
  4004c6:       68 01 00 00 00          pushq  $0x1
  4004cb:       e9 d0 ff ff ff          jmpq   4004a0 &lt;_init+0x18&gt;

...

00000000004005b4 &lt;main&gt;:
#include &lt;stdio.h&gt;
#include "stack.h"

int main(void)
{
  4005b4:       55                      push   %rbp
  4005b5:       48 89 e5                mov    %rsp,%rbp
    push('a');
  4005b8:       bf 61 00 00 00          mov    $0x61,%edi
  4005bd:       e8 fe fe ff ff          callq  4004c0 &lt;push@plt&gt;
    return 0;
  4005c2:       b8 00 00 00 00          mov    $0x0,%eax
}
  4005c7:       c9                      leaveq 
  4005c8:       c3                      retq   
  4005c9:       90                      nop
  4005ca:       90                      nop
  4005cb:       90                      nop
  4005cc:       90                      nop
  4005cd:       90                      nop
  4005ce:       90                      nop
  4005cf:       90                      nop

...
</code></pre>

<p>In <code>main(void)</code>, <code>push</code> is called by <code>callq  4004c0 &lt;push@plt&gt;</code>. Shared library is location irrelevant code, loaded to any address during runtime.</p>

<p>To see where it is allocated during runtime, we use <code>gdb</code>.</p>

<pre><code>$ gdb main

GNU gdb (GDB) Red Hat Enterprise Linux (7.2-60.el6_4.1)
Copyright (C) 2010 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;...
Reading symbols from /home/vagrant/proj/blog/linkage/shared_library/main...done.
(gdb) start
Temporary breakpoint 1 at 0x4005b8: file main.c, line 6.
Starting program: /home/vagrant/proj/blog/linkage/shared_library/main 

Temporary breakpoint 1, main () at main.c:6
6           push('a');
Missing separate debuginfos, use: debuginfo-install glibc-2.12-1.107.el6.x86_64
(gdb) si
0x00000000004005bd      6           push('a');
(gdb) si
0x00000000004004c0 in push@plt ()
(gdb) si
0x00000000004004c6 in push@plt ()
(gdb) si
0x00000000004004cb in push@plt ()
(gdb) si
0x00000000004004a0 in ?? ()
(gdb) si
0x00000000004004a6 in ?? ()
(gdb) si
0x00007ffff7df1660 in _dl_runtime_resolve () from /lib64/ld-linux-x86-64.so.2
(gdb) 
</code></pre>

<p>Use <code>si</code> to go into the assembly code. At last it does into the dynamic linker <code>/lib64/ld-linux-x86-64.so.2</code>. This dynamic linker will find <code>push()</code>, and after that the program can cal <code>push()</code>.</p>

<h3 id="i4_4">4.4 Shared library naming convention</h3>

<p>The name consists of real name, soname and linker name. <strong>Soname</strong> is a symbolic link name, contains only primary version number. Library files with the same soname must have the same interface. <code>libcap.so.1.10</code> and <code>libcap.so.1.11</code> have the same interface. It provides convenience for upgrading. <code>libc-2.8.90.so</code> is special. The primary version number is 6, not <code>2</code> or <code>2.8</code>.</p>

<p>Some linker names are symbolic links to a library, some are linking script. </p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>gcc -shared -Wl,-soname,libstack.so.1 -o libstack.so.1.0 stack.o push.o pop.o is_empty.o

<span class="nv">$ </span>gcc --help 

...
  -Wl,&lt;options&gt;            Pass comma-separated &lt;options&gt; on to the linker
...
</code></pre></div>

<p><code>-Wl,-soname,libstack.so.1</code> means <code>-soname libstack.so.1</code> is the option passed by gcc to the linker.</p>

<p>Now we have the <code>libstack.so.1.0</code> file. Its real name is <code>libstack.so.1.0</code>, and its soname is <code>libstack.so.1</code></p>

<pre><code>$ readelf -a libstack.so.1.0

...
Dynamic section at offset 0x7a0 contains 21 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libstack.so.1]
 0x000000000000000c (INIT)               0x4f0
 0x000000000000000d (FINI)               0x6b8
 0x000000006ffffef5 (GNU_HASH)           0x1b8
...
</code></pre>

            
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="C Essense (3) - Linkage" data-related="allenlsy">Tweet</a>
    </div>
    
    
    <div>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
    
    
    <div>
        <div class="g-plusone" data-size="medium"></div>
    </div>
    
    
    
    <div>
        <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
    </div>
    
</div>

        </section>
        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'allenlsy'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
      copy; 2014 &nbsp; 

        <nav>
            <a href="http://allenlsy.com">Blog</a> &middot;
            <a href="http://cast.allenlsy.com">Casts</a> &middot;
            
            
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/allenlsy" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/allenlsy" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
            
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24647338-1', '');
  ga('send', 'pageview');
</script>

</body>
</html>
