<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C Essense (2) - C and Assembly &mdash; Simple, Not Easy</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700|Oswald" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.jpg"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Simple, Not Easy" />
    <meta name="title" content="C Essense (2) - C and Assembly ">
    <link rel="canonical" href="/c-essense-2">
    
    <link rel="author" href="https://plus.google.com/118230970865161551961">
    <meta property="og:title" content="C Essense (2) - C and Assembly "/>
    <meta property="og:url" content="/c-essense-2"/>
    
    <meta property="og:image" content="/images/cppcafe.jpg"/>
    
    <meta property="og:image" content="/images/logo.jpg"/>
    
    
    <meta property="og:site_name" content="Simple, Not Easy">
    <link rel="stylesheet" href="/bt-responsive.css" type="text/css" media="screen" charset="utf-8">
    <meta name="keywords" content="c">
</head>
<body>

<section class="site-nav">
    <header>
        <nav id="navigation" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
            <a class="brand" href="/">
                <img src="/images/logo.jpg" alt="Inc">
            </a>
            <a href="/">Blog</a>
            
              <a href="/archives.html" >Archives</a>
            
              <a href="/about.html" >About</a>
            
              <a href="/tags.html" >Tags</a>
            
              <a href="http://cast.allenlsy.com" >Casts</a>
            
            <i class="icon-feed"></i> <a href="/feed.xml" title="Atom/RSS feed">Feed</a>
        </nav>

    </header>
</section>


<div class="article-cover">
    <div>
        <img src="/images/cppcafe.jpg" class="image">
    </div>
</div>

<article>

    <div class="container">
        <header>
            <h1 class="title">C Essense (2) - C and Assembly</h1>
            
            <div class="meta">
                <time pubdate datetime="2013-18-May" title="May 18, 2013">May 18, 2013</time>
            </div>
            <div class="tags">
              <a href="/tags/c.html" rel="tag">c</a>
            </div>
            <div class="hidden-seo">
              By <a href="/c-essense-2" title="C Essense (2) - C and Assembly" rel="author">allenlsy</a>
            </div>
        </header>

        <section>
            <blockquote>
  <p>The source code was tested and passed in <a href="http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130309.box">CentOS 6.4 vagrant box</a>
Github repository: <a href="http://github.com/allenlsy/c_essence">http://github.com/allenlsy/c_essence</a></p>
</blockquote>

<ul>
  <li><a href="#i1">1. <code>main()</code> and startup routine</a></li>
  <li><a href="#i2">2. Storage layout of variables</a></li>
  <li><a href="#i3">3. C inlines assembly</a></li>
</ul>

<hr />

<h2 id="i1">1. <code>main()</code> and startup routine</h2>

<p>The command <code>gcc main.c -o main</code>, it actually can be done in three separate steps:</p>

<ol>
  <li><code>gcc -S main.c</code>: compile <code>main.c</code> to assembly code <code>main.s</code></li>
  <li><code>gcc -c main.s</code>: compile <code>main.s</code> to target file <code>main.o</code></li>
  <li><code>gcc main.o</code>: compile <code>main.o</code> to executable file <code>a.out</code></li>
</ol>

<p><img src="/images/blog/cessense/pic11.png" alt="" /></p>

<p>In <em>C Essence (1)</em>, the first assembly program, we compile and link the program by:</p>

<div class="highlight"><pre><code class="sh">as hello.s -o hello.o
ld hello.o -o hello
</code></pre></div>

<p>If we link <code>hello.o</code> using <code>gcc</code>:</p>

<pre><code>$ gcc hello.o -o hello

hello.o: In function `_start':
(.text+0x0): multiple definition of `_start'
/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/crt1.o:(.text+0x0): first defined here
/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/crt1.o: In function `_start':
(.text+0x20): undefined reference to `main'
collect2: ld returned 1 exit status
</code></pre>

<p>There are two errors: </p>

<ol>
  <li>multiple definitions of <code>_start</code>: one is from the assembly code, the other is from <code>/sr/lib/crt1.o</code>.</li>
  <li><code>_start</code> in <code>crt1.o</code> need <code>main()</code>, and we don’t have <code>main()</code> in the assembly code</li>
</ol>

<p>From here we can see, <code>gcc</code> actually call <code>ld</code> to link <code>crt1.o</code> and <code>hello.o</code>. <code>crt1.o</code> has a <code>_start</code> entry point, we should not implement it ourselves if we want to use <code>gcc</code> to link. And <code>_start</code> need <code>main()</code>.</p>

<p><code>_start</code> will do some startup routine, and then call <code>main()</code> to do the real job. <strong>Therefore, the real entry point of a C program is <code>_start</code> rather than <code>main()</code></strong></p>

<h4 id="another-example">Another example</h4>

<div class="highlight"><pre><code class="cpp"><span class="c1">// function_call.c</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">bar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">e</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">bar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Compile it.</p>

<div class="highlight"><pre><code class="sh">gcc -c function_call.c
gcc function_call.o -o function_call
</code></pre></div>

<p>The last step is actually:</p>

<div class="highlight"><pre><code class="sh">ld /usr/lib64/crt1.o /usr/lib64/crti.o function_call.o -o function_call -lc -dynamic-linker /lib/ld-linux.so.2
</code></pre></div>

<p><code>-lc</code> means link to <code>libc</code> library. It is default option of <code>gcc</code>, but not of <code>ld</code>.</p>

<p><code>-dynamic-linker</code> is to assign dynamic linked library. </p>

<p>What is inside <code>crt1.o</code> and <code>crti.o</code>? </p>

<pre><code>$ whatis nm
nm                   (1)  - list symbols from object files

$ nm /usr/lib64/crt1.o
0000000000000000 R _IO_stdin_used
0000000000000000 D __data_start
                 U __libc_csu_fini
                 U __libc_csu_init
                 U __libc_start_main
0000000000000000 T _start
0000000000000000 W data_start
                 U main
</code></pre>

<p><code>U main</code> means <code>main</code> is used in <code>crt1.o</code>, but not defined(<code>U</code> stands for undefined), therefore other target file need to provide the <code>main</code> for <code>crt1.o</code>.</p>

<h4 id="symbol-resolution">Symbol Resolution</h4>

<p>If there is an instruction <code>push $main's_address</code>, since linker doesn’t know the address, <code>crt1.o</code> will replace it with <code>push $0x0</code>. When linking with <code>main.o</code>, the address will be replaced with the correct one. </p>

<p>Linker is an editor, like vi and emacs. Linker edit target file.</p>

<p><code>T _start</code> means <code>_start</code> is of type text, since <code>_start</code> is a piece of source code.</p>

<p>The <code>ld</code> command above is a simple version. Use <code>gcc -v</code> to see the details. <code>gcc -v function_call.c function_call</code></p>

<p><code>libc</code> is not linked into executable file. It is dynamiclly linked at runtime. <strong>Dynamic linking</strong> requires shared library, assigned with <code>-l</code> option. After dynamic linking, the whole linking process is finished.</p>

<p>Startup routine calls <code>main()</code>(actually should be <code>int main(int argc, char *argv[])</code>) by a equivalent C code of <code>exit(main(argc, argv))</code>. </p>

<p><code>exit()</code> is also defined in <code>libc</code>. <code>exit()</code> will do some cleanup routine before exit the program.</p>

<p><code>exit()</code> is defined in <code>stdlib.h</code> header file.</p>

<h2 id="i2">2. Storage layout of variables</h2>

<div class="highlight"><pre><code class="cpp"><span class="c1">// variable.c</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Hello world&quot;</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Compile it using debug mode. <code>gcc variable.c -g</code>. Then use <code>readelf</code> to see the section information.</p>

<pre><code>$ readelf -a a.out

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
...
  [15] .rodata           PROGBITS         00000000004005f8  000005f8
       0000000000000024  0000000000000000   A       0     0     8
...
  [24] .data             PROGBITS         00000000006008a8  000008a8
       0000000000000010  0000000000000000  WA       0     0     4


...
    49: 00000000006008b0     4 OBJECT  LOCAL  DEFAULT   24 b
    50: 00000000006008b4     4 OBJECT  LOCAL  DEFAULT   24 a.2055
    65: 0000000000400608     4 OBJECT  GLOBAL DEFAULT   15 A
    66: 00000000006008ac     4 OBJECT  GLOBAL DEFAULT   24 a
    75: 00000000006008c8     4 OBJECT  GLOBAL DEFAULT   25 c    
</code></pre>

<p>Let’s see the variables in hex format of <code>a.out</code>.</p>

<pre><code>...

00000600  00 00 00 00 00 00 00 00  0a 00 00 00 48 65 6c 6c  |............Hell|
00000610  6f 20 77 6f 72 6c 64 20  25 64 0a 00 01 1b 03 3b  |o world %d.....;|
00000620  20 00 00 00 03 00 00 00  a8 fe ff ff 3c 00 00 00  | ...........&lt;...|
...
000008a0  ce 03 40 00 00 00 00 00  00 00 00 00 14 00 00 00  |..@.............|
000008b0  1e 00 00 00 28 00 00 00  47 43 43 3a 20 28 47 4e  |....(...GCC: (GN|

...
</code></pre>

<p>Starting from 0x60c, it is the string value “Hello world”, at the end of <code>.rodata</code> section. <code>char []</code> is literal string, is read-only, equivalent to a global const array.</p>

<p>And also, 0x608, we find <code>0a</code>, which is <code>A = 10</code>.</p>

<p><code>.data</code> starts from 0x6008a8, length 0x10, which means 0x6008a8~0x6008b8. So <code>a</code>, <code>b</code>, <code>a.2055</code> are inside this part. <code>a</code> is <code>GLOBAL</code>, <code>b</code> is made <code>LOCAL</code> by the modifier <code>static</code>, so <code>b</code> will not be processed by the linker. <code>a.1589</code> is the local variable defined in <code>main()</code>. It is staticlly allocated, not allocated when being called and being release when function returns. </p>

<p><code>c</code> is within <code>.bss</code>. <strong>The difference between <code>.bss</code> and <code>.data</code> is</strong>, <code>.bss</code> does not take space in the file, filled with 0 when loading.</p>

<p>We don’t see the allocation of two local variables in <code>main()</code>. Local variable and parameter of a function is allocated on the stack. We use <code>objdump</code> to see them.</p>

<pre><code>$ objdump -dS a.out

...
int main(void)
{
  4004c4:	55                   	push   %rbp
  4004c5:	48 89 e5             	mov    %rsp,%rbp
  4004c8:	53                   	push   %rbx
  4004c9:	48 83 ec 18          	sub    $0x18,%rsp
  static int a = 40;
  char b[] = "Hello world";
  4004cd:	c7 45 e0 48 65 6c 6c 	movl   $0x6c6c6548,-0x20(%rbp)
  4004d4:	c7 45 e4 6f 20 77 6f 	movl   $0x6f77206f,-0x1c(%rbp)
  4004db:	c7 45 e8 72 6c 64 00 	movl   $0x646c72,-0x18(%rbp)
  register int c = 50;
  4004e2:	bb 32 00 00 00       	mov    $0x32,%ebx
  
  printf("Hello world %d\n", c);
  4004e7:	b8 0c 06 40 00       	mov    $0x40060c,%eax
  4004ec:	89 de                	mov    %ebx,%esi
  4004ee:	48 89 c7             	mov    %rax,%rdi
  4004f1:	b8 00 00 00 00       	mov    $0x0,%eax
  4004f6:	e8 bd fe ff ff       	callq  4003b8 &lt;printf@plt&gt;
  
  return 0;
  4004fb:	b8 00 00 00 00       	mov    $0x0,%eax
}

...
</code></pre>

<p>See, for <code>b[]</code>, it moves the 12 bytes data from <code>.rodata</code> to the stack directly. The address of <code>b[]</code> is from <code>%rbp-0x20</code> to <code>%rbp-0x18</code>.</p>

<p><code>c</code> is not on the stack. It is inside the register <code>%ebx</code>. That is how keyword <code>register</code> takes effect.</p>

<h3 id="scope">Scope</h3>

<p>Use only <strong>local</strong> and <strong>global</strong> to classify variable according to scope <strong>IS NOT APPROPRIATE</strong>. Scope can be applied to any label. There are 4 scopes in C language:</p>

<ul>
  <li><strong>Function Scope</strong>: label lives in the function</li>
  <li><strong>File Scope</strong>: label lives from declaration to the end of the file. </li>
  <li><strong>Block Scope</strong>: label lives in brackets {}</li>
  <li><strong>Function Prototype Scope</strong>: label lives in the prototype(signature) of a function. eg. <code>int foo(int a, int b);</code></li>
</ul>

<p>Label has 3 <strong>Linkage</strong>:</p>

<ul>
  <li><strong>External linkage</strong>: If the final executable file is linked by multiple files, the label refers to the same thing no matter how many times it is declared. They are <code>GLOBAL</code> label.</li>
  <li><strong>Internal linkage</strong>: the label refers to the same thing no matter how many times it is declared within the same file.</li>
  <li><strong>No linkage</strong>: Other than external linkage and internal linkage.</li>
</ul>

<p>There are several difference <strong>Storage Class Specifier</strong>:</p>

<ul>
  <li><strong>static</strong>: staticlly allocated. Internal Linkage</li>
  <li><strong>auto</strong>: automatically allocated on the stack, released when function returns.</li>
  <li><strong>register</strong>: allocated on a register. If there is no register available, then it is regarded as <code>auto</code></li>
  <li><strong>extern</strong>: discuss in detail later</li>
  <li><strong>typedef</strong>: define a type name</li>
</ul>

<p>Notice that <code>const</code> is not storage class specifier. It is <strong>Type qualifier</strong>.</p>

<p>There are several kinds of variables’s <strong>Storage Duration(lifetime)</strong>:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>Allocated</th>
      <th>Released</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Static Storage Duration</strong></td>
      <td>when program starts</td>
      <td>when program ends</td>
    </tr>
    <tr>
      <td><strong>Automatic Storage Duration</strong></td>
      <td>when enter a block, allocated on stack</td>
      <td>when exit the block</td>
    </tr>
    <tr>
      <td><strong>Allocated Storage Duration</strong></td>
      <td>using <code>malloc</code></td>
      <td>using <code>free</code></td>
    </tr>
  </tbody>
</table>

<h2 id="i3">3. C inlines assembly</h2>

<p>To inline assembly, use <code>__asm__("assembly code")</code></p>

<div class="highlight"><pre><code class="cpp"><span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">__asm__</span><span class="p">(</span>	<span class="s">&quot;movl %1, %%eax</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;movl %%eax, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="o">:</span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
				<span class="o">:</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
				<span class="o">:</span><span class="s">&quot;%eax&quot;</span>
				<span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Result: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


            
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="C Essense (2) - C and Assembly" data-related="allenlsy">Tweet</a>
    </div>
    
    
    <div>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
    
    
    <div>
        <div class="g-plusone" data-size="medium"></div>
    </div>
    
    
    
    <div>
        <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
    </div>
    
</div>

        </section>
        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'allenlsy'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
      copy; 2014 &nbsp; 

        <nav>
            <a href="http://allenlsy.com">Blog</a> &middot;
            <a href="http://cast.allenlsy.com">Casts</a> &middot;
            
            
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/allenlsy" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/allenlsy" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
            
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24647338-1', '');
  ga('send', 'pageview');
</script>

</body>
</html>
