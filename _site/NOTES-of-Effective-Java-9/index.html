<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Effective Java 9 - Concurrency &mdash; Simple, Not Easy</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700|Oswald" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.jpg"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Simple, Not Easy" />
    <meta name="title" content="Effective Java 9 - Concurrency ">
    <link rel="canonical" href="/NOTES-of-Effective-Java-9">
     
    <link rel="author" href="https://plus.google.com/118230970865161551961">       
    <meta property="og:title" content="Effective Java 9 - Concurrency "/>
    <meta property="og:url" content="/NOTES-of-Effective-Java-9"/>
    
    
    <meta property="og:site_name" content="Simple, Not Easy">
    
    <meta property="keywords" content="java">
    
</head>
<body>
    
<section class="site-nav">
    <header>
        <nav id="navigation" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
            <a class="brand" href="/">
                <img src="/images/logo.jpg" alt="Inc">
            </a>
            <a href="/">Blog</a>
            
              <a href="/archives.html" >Archives</a>
            
              <a href="/about.html" >About</a>
            
              <a href="/tags.html" >Tags</a>
            
              <a href="http://cast.allenlsy.com" >Casts</a>
            
            <i class="icon-feed"></i> <a href="/feed.xml" title="Atom/RSS feed">Feed</a>
        </nav>

    </header>
</section>


<article>

    <div class="container">
        <header>
            <h1 class="title">Effective Java 9 - Concurrency</h1>
            
            <div class="meta">
                <time pubdate datetime="2013-28-May" title="May 28, 2013">May 28, 2013</time>
            </div>
            <div class="tags">
              <a href="/tags/java.html" rel="tag">java</a>
            </div>
            <div class="hidden-seo">
              By <a href="/NOTES-of-Effective-Java-9" title="Effective Java 9 - Concurrency" rel="author">allenlsy</a>
            </div>
        </header>

        <section>
            <p><img src="http://www.crazysmoove.com/memjug/javabooks-slides/images/Effective_Java.jpg" alt="" />
<br /></p>

<ul>
  <li><a href="#i66">66. Synchronize access to shared mutable data</a></li>
  <li><a href="#i67">67. Avoid excessive synchronization</a></li>
  <li><a href="#i68">68. Prefer executors and tasks to threads</a></li>
  <li><a href="#i69">69. Prefer concurrency utilities to wait and notify</a></li>
  <li><a href="#i70">70. Document thread safety</a></li>
  <li><a href="#i71">71. Use lazy initialization judiciously</a></li>
  <li><a href="#i72">72. Donâ€™t depend on the thread scheduler</a></li>
  <li><a href="#i73">73. Avoid thread groups</a></li>
</ul>

<hr />

<blockquote>
  <p><code>synchronized</code> keyword makes sure that at the same time, there is only thread accessing all the synchronized methods in the object.</p>
</blockquote>

<h2 id="i66">66. Synchronize access to shared mutable data</h2>

<p>The way to stop a thread interrupting another thread, the thread should poll a boolean field, which initialized with <code>false</code>, but the second thread can set it to <code>true</code>.</p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StopThread</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">stopRequested</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
		<span class="n">Thread</span> <span class="n">backgroundThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="k">while</span><span class="o">(!</span><span class="n">stopRequested</span><span class="o">)</span>
					<span class="n">i</span><span class="o">++;</span>
			<span class="o">}</span>
		<span class="o">});</span>
		<span class="n">backgroundThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

		<span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="n">stopRequested</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>Without <code>synchronize</code>, it is not guaranteed that backgoundThread sees the changed <code>stopRequested</code>. The VM will compile the <code>while</code> loop into:</p>

<div class="highlight"><pre><code class="java"><span class="k">if</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span>
	<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span>
		<span class="n">i</span><span class="o">++;</span>
</code></pre></div>

<p>This is an optimization called <strong>Hoisting</strong>.</p>

<p>When a new thread start, it will first read and load <code>stopRequested</code> from the main memory, which means the threads keeps a copy of <code>stopRequested</code> in the thread working memory. Until the thread finishes, it will only use the copy.</p>

<p><strong>Solution to this is:</strong></p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StopThread</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">stopRequested</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">requestStop</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">stopRequested</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">stopRequested</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">stopRequested</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
		<span class="n">Thread</span> <span class="n">backgroundThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="k">while</span><span class="o">(!</span><span class="n">stopRequested</span><span class="o">)</span>
					<span class="n">i</span><span class="o">++;</span>
			<span class="o">}</span>
		<span class="o">});</span>
		<span class="n">backgroundThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

		<span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="n">requestStop</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>We synchronized both reading and writing. Only synchronize writing will not actually work.</p>

<p><strong>Another solution is</strong> to use <code>volatile</code> keyword. It means that the variable in the thread will not use the copy. It will be notified when the variable is updated.</p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StopThread</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">stopRequested</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
		<span class="n">Thread</span> <span class="n">backgroundThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="k">while</span><span class="o">(!</span><span class="n">stopRequested</span><span class="o">)</span>
					<span class="n">i</span><span class="o">++;</span>
			<span class="o">}</span>
		<span class="o">});</span>
		<span class="n">backgroundThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

		<span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="n">stopRequested</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>But the purpose of <code>volatile</code> is to use the latest value. It does not guarantee synchronization. </p>

<h4 id="example-generating-sequential-number">Example: generating sequential number</h4>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">nextNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">generateNumber</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">nextNumber</span><span class="o">++;</span>
<span class="o">}</span>
</code></pre></div>

<p><code>++</code> operation on <code>nextNumber</code> is not atomic. This program may fail. </p>

<p>One solution is to add <code>synchronized</code> to <code>generateNumber()</code>. </p>

<p>Another way is to use Java API <code>java.util.concurrent.atomic.AtomicLong</code>. It is what we want, and it may perform better.</p>

<blockquote>
  <p><strong>Limit variable data in a single thread. Some one calls your program may put it in a multiple threading environment.</strong></p>
</blockquote>

<h2 id="i67">67. Avoid excessive synchronization</h2>

<p>This example uses composite-over-inheritance design to create an observer class.</p>

<div class="highlight"><pre><code class="java"><span class="kd">class</span> <span class="nc">ForwardingSet</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">;</span>
	<span class="kd">public</span> <span class="nf">ForwardingSet</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span> <span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span> <span class="n">s</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">o</span><span class="o">);</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="n">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">o</span><span class="o">);</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span> <span class="o">?</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">containsAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span> <span class="o">?</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span> <span class="o">?</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">retainAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="o">}</span>

	<span class="kd">public</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="o">&lt;</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="n">T</span><span class="o">[]</span> <span class="n">toArray</span><span class="o">(</span><span class="n">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">a</span><span class="o">);</span> <span class="o">}</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">o</span><span class="o">);</span> <span class="o">}</span>
	<span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="n">hashCode</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span> <span class="o">}</span>
	<span class="nd">@Override</span> <span class="kd">public</span> <span class="n">String</span> <span class="n">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span> <span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span>
	<span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="c1">// Invoked when an element is added to the observable set</span>
	<span class="kt">void</span> <span class="nf">added</span><span class="o">(</span><span class="n">ObservableSet</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">set</span><span class="o">,</span> <span class="n">E</span> <span class="n">element</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ObservableSet</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ForwardingSet</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">ObservableSet</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">set</span><span class="o">);</span> <span class="o">}</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">observers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">&gt;();</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addObserver</span><span class="o">(</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">synchronized</span><span class="o">(</span><span class="n">observers</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">observers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeObserver</span><span class="o">(</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">synchronized</span><span class="o">(</span><span class="n">observers</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">observers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyElementAdded</span><span class="o">(</span><span class="n">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">synchronized</span><span class="o">(</span><span class="n">observers</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">observer</span> <span class="o">:</span> <span class="n">observers</span><span class="o">)</span>
				<span class="n">observer</span><span class="o">.</span><span class="na">added</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="n">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">boolean</span> <span class="n">added</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">added</span><span class="o">)</span> 
			<span class="n">notifyElementAdded</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">added</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">E</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span> <span class="n">E</span> <span class="n">element</span> <span class="o">:</span> <span class="n">c</span><span class="o">)</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="n">add</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">ObservableSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObservableSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">);</span>
		
		<span class="n">set</span><span class="o">.</span><span class="na">addObserver</span><span class="o">(</span><span class="k">new</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">added</span><span class="o">(</span><span class="n">ObservableSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">});</span>
		
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
			<span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>Currently this program works fine. It prints out the numbers from 0 to 99. </p>

<p>If we change the observer in the <code>set</code>:</p>

<div class="highlight"><pre><code class="java"><span class="n">set</span><span class="o">.</span><span class="na">addObserver</span><span class="o">(</span><span class="k">new</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">()</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">added</span><span class="o">(</span><span class="n">ObservableSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="mi">23</span><span class="o">)</span>
			<span class="n">s</span><span class="o">.</span><span class="na">removeObserver</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>We expect the program to end after printing 23. This will be illegal, since we are trying to delete an element from the set DURING we are iterating the set. <code>notifyElementAdded</code> is a synchronized block. </p>

<h4 id="continue-the-example">Continue the example</h4>

<p>Now we are trying to unsubscribe the observer using another thread.</p>

<div class="highlight"><pre><code class="java"><span class="n">set</span><span class="o">.</span><span class="na">addObserver</span><span class="o">(</span> <span class="k">new</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">()</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">added</span><span class="o">(</span><span class="kd">final</span> <span class="n">ObservableSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="mi">23</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
			<span class="kd">final</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">observer</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
					<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
						<span class="n">s</span><span class="o">.</span><span class="na">removeObserver</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}).</span><span class="na">get</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">});</span>

<span class="n">set</span><span class="o">.</span><span class="na">addObserver</span><span class="o">(</span><span class="k">new</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">added</span><span class="o">(</span><span class="n">ObservableSet</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span> <span class="n">e</span> <span class="o">==</span> <span class="mi">23</span> <span class="o">)</span>
			<span class="n">s</span><span class="o">.</span><span class="na">removeObserver</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">});</span>

<span class="o">...</span>
		
</code></pre></div>

<p><code>Executor</code> service is provided by <code>java.util.concurrent</code> package.</p>

<p>The new observer is added before the previous one. It encounters deadlock. Because in the main thread, <code>add()</code> calls <code>notifyElementAdded()</code>, the later locks <code>observers</code>. And the newly added observer also want to gain the lock.</p>

<p>Calling external method, a method from outside of the containing class, always causes deadlock. We can move the external method out of the synchronized block, by making a snapshot, and operate on the snapshot.</p>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyElementAdded</span><span class="o">(</span><span class="n">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">List</span><span class="o">&lt;</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span> <span class="n">snapshot</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kd">synchronized</span><span class="o">(</span><span class="n">observers</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">snapshot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;(</span><span class="n">observers</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">for</span> <span class="o">(</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">observer</span> <span class="o">:</span> <span class="n">observers</span><span class="o">)</span>
		<span class="n">observer</span><span class="o">.</span><span class="na">added</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>

<p>A better way to move external method out of synchronized code block is by using <strong>concurrent collection</strong> (since Java 1.5). This is a variant of <code>ArrayList</code>, does all the operations in a copy of the low level array. Therefore it does not require synchronization, and the performance is good. If the program changes the array a lot, the performance will not be good. But for the observer list here, it is very good.</p>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">observers</span> <span class="o">=</span> 
	<span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="o">&gt;();</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addObserver</span><span class="o">(</span> <span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">observers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeObserver</span><span class="o">(</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">observers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyElementAdded</span><span class="o">(</span><span class="n">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">for</span> <span class="o">(</span><span class="n">SetObserver</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">observer</span> <span class="o">:</span> <span class="n">observers</span><span class="o">)</span>
		<span class="n">observer</span><span class="o">.</span><span class="na">added</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="i68">68. Prefer executors and tasks to threads</h2>

<p><strong>Executor</strong> is an interface-based task executor. To use it:</p>

<div class="highlight"><pre><code class="java"><span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
<span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
<span class="o">...</span>
<span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</code></pre></div>

<p>If you want to use more than one thread to deal with a task queue, just use a executor service factory(which actually is a <strong>thread pool</strong>), or directly <code>ThreadPoolExecutor</code> class in Java.</p>

<p>For a small project, <code>Executors.newCachedThreadPool</code> is a good choice, but not for a big project. It may make the server overloaded. </p>

<h3 id="executor-framework">Executor Framework</h3>

<p>Previously, thread is both the working unit and the working mechanism. Now we need toe separate them. Working unit should be <code>Runnable</code> or <code>Callable</code>, <code>Runnable</code> returns value. Working mechanism is executor service. </p>

<p><code>ScheduledThreadPoolExecutor</code> in Executor Framework can replace <code>java.util.Timer</code>. </p>

<p>Please refer to <em>Java Concurrency in Practice</em> for more details on Executor Framework.</p>

<h2 id="i69">69. Prefer concurrency utilities to wait and notify</h2>

<p>From Java 1.5, <code>java.util.concurrent</code> has three kinds of tools: Executor Framework, Concurrent Collection and Synchronizer.</p>

<h3 id="concurrent-collection">Concurrent Collection</h3>

<p>It provides high performance concurrency for traditional Collections like <code>List</code> and <code>Queue</code>. If you use concurrent collection, make sure you have concurrent job inside, otherwise you will only slow down your program.</p>

<p><code>ConcurrentMap</code> extends from <code>Map</code>.</p>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> 
	<span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">intern</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">String</span> <span class="n">previousValue</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">previousValue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">s</span> <span class="o">:</span> <span class="n">previousValue</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>

<p><code>ConcurrentHashMap</code> is even better.</p>

<p>Prefer <code>ConcorrentHashMap</code> to <code>Collections.synchronizedMap</code> or <code>Hashtable</code></p>

<p>Most of the <code>ExecutorService</code>s have implemented BlockingQueue. They will be blocked until operation finishes.</p>

<h3 id="synchronizer">Synchronizer</h3>

<p>It makes thread waiting for another thread, and collaborate. Most common synchronizers are <code>CountDownLatch</code> and <code>Semaphore</code>.</p>

<p><code>CountDown Latch</code> is a single-use barrier, makes threads waiting for other threads. </p>

<h4 id="example-countdown-latch">Example: CountDown Latch</h4>

<p>Suppose we have a batch of tasks, they need to start at the same time. Before they start, they need to get ready. Once all the tasks are ready, they start together, and a timer starts counting. Once last task finishes, the timer stops counting.</p>

<div class="highlight"><pre><code class="java"><span class="c1">// int concurrency is the concurrency level, means the number of times the countDown() has to be called</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">time</span><span class="o">(</span><span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">concurrency</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">action</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="n">CountDownLatch</span> <span class="n">ready</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">concurrency</span><span class="o">);</span>
	<span class="kd">final</span> <span class="n">CountDownLatch</span> <span class="n">start</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">concurrency</span><span class="o">);</span>
	<span class="kd">final</span> <span class="n">CountDownLatch</span> <span class="n">done</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">concurrency</span><span class="o">);</span>

	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">concurrency</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">ready</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">start</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
					<span class="n">action</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>

				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
					<span class="n">done</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>
	<span class="n">ready</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
	<span class="kt">long</span> <span class="n">startNanos</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
	<span class="n">start</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
	<span class="n">done</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
	<span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">startNanos</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>

<p><code>start.await()</code> means wait here, until the <code>start</code>. <code>done.await()</code> waits there, until it becomes 0, then return the running time.</p>

<p><strong>Use <code>System.nanoTime</code> instead of <code>System.currentTimeMills</code></strong></p>

<h2 id="i70">70. Document thread safety</h2>

<p>A method documented with <code>@synchronized</code> does not mean that it is completely thread-safe.</p>

<p>There are several thread security levels:</p>

<ul>
  <li><strong>Immutable</strong>: the instance is immutable, no need external synchronization. eg. <code>String</code>, <code>Long</code>, <code>BigInteger</code></li>
  <li><strong>Unconditionally thread-safe</strong>: the instance can be changed, but it has sufficient internal synchronization that its instances can be used concurrently without the need for any external synchronization. eg. <code>Random</code> and <code>ConcurrentHashMap</code> </li>
  <li><strong>Conditionally thread-safe</strong>: some methods require external synchronization for safe concurrent use.</li>
  <li><strong>Not thread-safe</strong>: instances are mutable. Client must surround each method invocation with external synchronization if the method will be used concurrently.</li>
  <li><strong>thread-hostile</strong>: This class is not safe even if all method invocations are surrounded by external synchronization.</li>
</ul>

<p>Thread-safe type should be documented. </p>

<h4 id="private-lock-object">Private lock object</h4>

<p>Private lock object can be an alternative of synchronized block.</p>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">()</span> <span class="o">{</span>
	<span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>

	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>Private lock object can only be applied to unconditional thread-safe. Because in conditional thread-safe method, you must document which lock the user has to gain.</p>

<h2 id="i71">71. Use lazy initialization judiciously</h2>

<p>Lazy initialization is an optimization technique. </p>

<p>Lazy initialization should only be used when the initialization cost is high. </p>

<p>If multiple threads are using a lazy-initialed object, you should be careful about the initialization.</p>

<p>A typical way to initialed an object:</p>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">FieldType</span> <span class="n">field</span> <span class="o">-</span> <span class="n">conputeFieldValue</span><span class="o">();</span>
</code></pre></div>

<p>If we use lazy initialization, that part needs to be synchronized:</p>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="n">FieldType</span> <span class="n">field</span><span class="o">;</span>

<span class="kd">synchronized</span> <span class="n">FieldType</span> <span class="nf">getField</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">field</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">computeFieldValue</span><span class="o">();</span>
	<span class="k">return</span> <span class="n">field</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>

<p>If we need to lazy initiate a static field, we can use <strong>lazy initialization holder class</strong>.</p>

<div class="highlight"><pre><code class="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FieldHolder</span> <span class="o">{</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="n">FieldType</span> <span class="n">field</span> <span class="o">=</span> <span class="n">computerFieldValue</span><span class="o">();</span>
<span class="o">}</span>
<span class="kd">static</span> <span class="n">FieldType</span> <span class="nf">getField</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">FieldHolder</span><span class="o">.</span><span class="na">field</span><span class="o">;</span> <span class="o">}</span>
</code></pre></div>

<p>When <code>getField()</code> get called for the first time, it accesses <code>FieldHolder.field</code>, which makes <code>FieldHolder</code> class initialized. Later <code>getField()</code> will return the created object. The point is we donâ€™t need to add <code>synchronized</code> before <code>getField()</code>, and the code is safe.</p>

<h2 id="i72">72. Donâ€™t depend on the thread scheduler</h2>

<p>Any program that replies on the thread scheduler for correctness or performance is likely to be nonportable.</p>

<p>Weâ€™d better keep the average number of threads running to be less than the number of CPU cores. To achieve that, we need to make thread do more meaningful tasks. Meanwhile keep thread pool small. </p>

<p>Donâ€™t make thread in a <strong>busy-wait</strong> state, repeating checking the state of a shared object.</p>

<p>Donâ€™t use <code>Thread.yield</code> to gain more CPU time for a thread. This is nonportable. You should redesign the application and decrease the number of concurrent threads. <code>Thread.yield</code> should only be used in testing.</p>

<h2 id="i73">73. Avoid thread groups</h2>

<p>The <strong>thread group</strong> that Java provided is very insecure.</p>

<p>Try to use thread pool executor instead.</p>

            
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Effective Java 9 - Concurrency" data-related="allenlsy">Tweet</a>
    </div>
    
    
    <div>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
    
    
    <div>
        <div class="g-plusone" data-size="medium"></div>
    </div>
    
    
    
    <div>
        <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
    </div>
    
</div>

        </section>
        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'allenlsy'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
      &copy; 2013 &nbsp;  
        
        <nav>
            <a href="http://allenlsy.com">Blog</a> &middot;
            <a href="http://cast.allenlsy.com">Casts</a> &middot;
            
            
        </nav>
        
        <nav class="social">
            
            <a href="https://twitter.com/allenlsy" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/allenlsy" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
                
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24647338-1', '');
  ga('send', 'pageview');
</script>

</body>
</html>
