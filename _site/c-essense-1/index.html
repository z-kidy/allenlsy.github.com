<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C Essense (1) - x86 Assembly Programming Basic &mdash; Simple, Not Easy</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700,800|Oswald|PT+Mono|Ubuntu+Mono" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.jpg"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Simple, Not Easy" />
    <meta name="title" content="C Essense (1) - x86 Assembly Programming Basic ">
    <link rel="canonical" href="/c-essense-1">
    
    <link rel="author" href="https://plus.google.com/118230970865161551961">
    <meta property="og:title" content="C Essense (1) - x86 Assembly Programming Basic "/>
    <meta property="og:url" content="/c-essense-1"/>
    
    <meta property="og:image" content="/images/cppcafe.jpg"/>
    
    <meta property="og:image" content="/images/logo.jpg"/>
     
    
    <meta property="og:site_name" content="Simple, Not Easy">
    <link rel="stylesheet" href="/bt-responsive.css" type="text/css" media="screen" charset="utf-8">
    <meta name="keywords" content="c">
</head>
<body>

<section class="site-nav">
    <header>
        <nav id="navigation" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
            <a class="brand" href="/">
                <img src="/images/logo.jpg" alt="Inc">
            </a>
            <a href="/">Blog</a>
            
              <a href="/archives.html" >Archives</a>
            
              <a href="/about.html" >About</a>
            
              <a href="/tags.html" >Tags</a>
            
              <a href="http://cast.allenlsy.com" >Casts</a>
            
            <i class="icon-feed"></i> <a href="/feed.xml" title="Atom/RSS feed">Feed</a>
        </nav>

    </header>
</section>


<div class="article-cover">
    <div>
        <img src="/images/cppcafe.jpg" class="image">
    </div>
</div>

<article>

    <div class="container">
        <header>
            <h1 class="title">C Essense (1) - x86 Assembly Programming Basic</h1>
            
            <div class="meta">
                <time pubdate datetime="2013-17-May" title="May 17, 2013">May 17, 2013</time>
            </div>
            <div class="tags">
              <a href="/tags/c.html" rel="tag">c</a>
            </div>
            <div class="hidden-seo">
              By <a href="/c-essense-1" title="C Essense (1) - x86 Assembly Programming Basic" rel="author">allenlsy</a>
            </div>
        </header>

        <section class="article">
            <blockquote>
  <p>The source code was tested and passed in <a href="http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130309.box">CentOS 6.4 vagrant box</a>
Github repository: <a href="http://github.com/allenlsy/c_essence">http://github.com/allenlsy/c_essence</a></p>
</blockquote>

<ul>
  <li><a href="#i1">1. Simple assembly program</a></li>
  <li><a href="#i2">2. Second assembly program</a></li>
  <li><a href="#i3">3. ELF file</a>
    <ul>
      <li><a href="#i3-1">3.1 Target file</a></li>
      <li><a href="#i3-2">3.2. Executable file</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="i1">1. Simple assembly program</h2>

<p>Suppose we have an assembly program <code>hello.s</code>, and we need to compile and link it.</p>

<div class="highlight"><pre><code class="asm"><span class="c"># hello.s</span>
<span class="na">.section</span> <span class="no">.data</span>
<span class="na">.section</span> <span class="no">.text</span>
<span class="na">.globl</span> <span class="no">_start</span>
<span class="nl">_start:</span>
<span class="nf">movl</span> <span class="no">$1</span><span class="p">,</span> <span class="nv">%eax</span>
<span class="nf">movl</span> <span class="no">$4</span><span class="p">,</span> <span class="nv">%ebx</span>
<span class="nf">int</span> <span class="no">$0x80</span>
</code></pre></div>

<p>In this program:</p>

<p><code>.section</code> make thie code into several sections. When the program being load, each section will 
be loaded to different address, with different I/O right. </p>

<p><code>.data</code> section saves the data, it has r/w right. </p>

<p><code>.text</code> section saves the code. It has r/x right.</p>

<p><code>.globl</code> declares a variable to be marked as <code>GLOBAL</code>. </p>

<p><code>_start</code> is a symbol that will be used by the linker. It is a special symbol indicates the start of the program, like <code>main()</code> in C program. If there is no <code>_start</code> symbol, then the program cannot be run directly.</p>

<p>Variables start with <code>%</code> means registers in the CPU. </p>

<p><code>movl</code> means move a long variable. <code>$1</code> is a number 1, be moved into <code>%eax</code>.</p>

<p><code>int $0x80</code> is special. <code>int</code> command is a soft interruption command, generates an exception for the system, makes the CPU switch from user mode to privilige mode and then jump into kernel code. <code>$0x80</code> is a parameter. <code>int $0x80</code> raises a system call exception.</p>

<p>When there is a system call exception, the system reads the system call code from <code>%eax</code> and  the parameter for this call from <code>%exb</code>. <code>1</code> in system call means <code>_exit</code> call, <code>%ebx</code> is the actually the exit state <code>4</code>.</p>

<h4 id="compile-link-run">Compile, link, run</h4>

<pre><code>as hello.s -o hello.o
ld hello.o -o hello
./hello
echo $?
</code></pre>

<p><code>as</code> will compile hello.s to machine language, and <code>ld</code> will link <strong>target file</strong> <code>hello.o</code> to an <strong>executable file</strong> <code>hello</code>.</p>

<p><strong>Linking</strong> is a process to combine multiple target file into an executable file. During the process, it also modifies some information of the target file.</p>

<p>In shell, <code>$?</code> command is used to get the return value of last command. Let’s run <code>hello</code>. Then we see the exit code <code>4</code>.</p>

<h2 id="i2">2. Second assembly program</h2>

<div class="highlight"><pre><code class="asm"><span class="c"># max.s</span>

<span class="na">.section</span> <span class="no">.data</span>
<span class="nl">data_items:</span>
    <span class="na">.long</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">0</span>

<span class="na">.section</span> <span class="no">.text</span>
<span class="na">.globl</span> <span class="no">_start</span>
<span class="nl">_start:</span>
    <span class="c"># move 0 into the index register</span>
    <span class="nf">movl</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%edi</span>

    <span class="c"># load the first byte of data into %eax</span>
    <span class="nf">mov</span> <span class="no">data_items</span><span class="p">(,</span><span class="nv">%edi</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="nv">%eax</span>

    <span class="c"># %eax is the biggest now, %ebx is used to store the biggest</span>
    <span class="nf">mov</span> <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%ebx</span>

<span class="nl">start_loop:</span>
    <span class="c"># check to see if we&#39;ve hit the end. Last item is 0</span>
    <span class="nf">cmpl</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%eax</span>

    <span class="c"># jump to loop_exit if comparison result is equal</span>
    <span class="nf">je</span> <span class="no">loop_exit</span>
    
    <span class="c"># increase the value of %edi</span>
    <span class="nf">incl</span> <span class="nv">%edi</span>

    <span class="c"># load next data_item into %eax</span>
    <span class="nf">movl</span> <span class="no">data_items</span><span class="p">(,</span><span class="nv">%edi</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="nv">%eax</span>

    <span class="c"># compare value</span>
    <span class="nf">cmpl</span> <span class="nv">%ebx</span><span class="p">,</span> <span class="nv">%eax</span>

    <span class="c"># jumo to start_loop if comparison result is less than (&lt;)</span>
    <span class="nf">jle</span> <span class="no">start_loop</span>

    <span class="c"># then means %eax is larger than %ebx, which is the current biggest.</span>
    <span class="nf">movl</span> <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%ebx</span>

    <span class="nf">jmp</span> <span class="no">start_loop</span>

<span class="nl">loop_exit:</span>
    <span class="c"># %ebx is the status code for _exit system call and</span>
    <span class="c"># it already has the maximum number</span>
    <span class="nf">movl</span> <span class="no">$1</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="nf">int</span> <span class="no">$0x80</span>
</code></pre></div>

<p>Compile and run</p>

<div class="highlight"><pre><code class="sh">as max.s -o max.o
ld max.o -o max
./max
<span class="nb">echo</span> <span class="nv">$?</span>
</code></pre></div>

<p>Analyse the program yourself.</p>

<h2 id="i3">3. ELF file</h2>

<p><strong>ELF</strong> is an open standard for all the executable file in UNIX. It has three types:</p>

<ul>
  <li>Relocatable</li>
  <li>Executable</li>
  <li>Shared Object</li>
</ul>

<h3 id="i3-1">3.1 Target file</h3>

<p><img src="/images/blog/cessense/pic1.png" alt="" /></p>

<p>ELF file has two perspective to view it. From <strong>compiler and linker’s perspective</strong>, ELF uses <strong>Section Header Table</strong> to describe a set of sections. From <strong>Loader’s perspective</strong>, ELF uses <strong>Program Header Table</strong> to describe a set of segments. </p>

<p><strong>ELF Header</strong> describes the system architecture and other system information, and points to Section Header Table and Program Header Table.</p>

<p><strong>Section Header Table</strong> stores the section description.</p>

<p>Compiler and linker do not need Program Header Table, so it is optional to them.</p>

<p><strong>Program Header Table</strong> stores the segments description. </p>

<p>Loader does not need section information, so Section Header table is optional to loader.</p>

<p>Let’s see the elf file structure, use <code>readelf -a max.o</code> command to see it. <code>-a</code> means all.</p>

<pre><code>ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          224 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           64 (bytes)
  Number of section headers:         8
  Section header string table index: 5

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040
       000000000000002d  0000000000000000  AX       0     0     4
  [ 2] .rela.text        RELA             0000000000000000  000003c8
       0000000000000030  0000000000000018           6     1     8
  [ 3] .data             PROGBITS         0000000000000000  00000070
       0000000000000038  0000000000000000  WA       0     0     4
  [ 4] .bss              NOBITS           0000000000000000  000000a8
       0000000000000000  0000000000000000  WA       0     0     4
  [ 5] .shstrtab         STRTAB           0000000000000000  000000a8
       0000000000000031  0000000000000000           0     0     1
  [ 6] .symtab           SYMTAB           0000000000000000  000002e0
       00000000000000c0  0000000000000018           7     7     8
  [ 7] .strtab           STRTAB           0000000000000000  000003a0
       0000000000000028  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)

There are no section groups in this file.

There are no program headers in this file.

Relocation section '.rela.text' at offset 0x3c8 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000009  00020000000b R_X86_64_32S      0000000000000000 .data + 0
00000000001a  00020000000b R_X86_64_32S      0000000000000000 .data + 0

There are no unwind sections in this file.

Symbol table '.symtab' contains 8 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 
     4: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    3 data_items
     5: 000000000000000f     0 NOTYPE  LOCAL  DEFAULT    1 start_loop
     6: 0000000000000026     0 NOTYPE  LOCAL  DEFAULT    1 loop_exit
     7: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT    1 _start

No version information found in this file.
</code></pre>

<p>From here we can see the ELF Header, the Section Header, and there are not section groups and program headers.</p>

<p>In <code>Section headers</code>, we have <code>.text</code> and <code>.data</code> section.</p>

<p>Based on the output, we can depict the layout of this target file.</p>

<table>
  <thead>
    <tr>
      <th>Starting address</th>
      <th>Section or Header</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>Start of ELF Header</td>
    </tr>
    <tr>
      <td>0x40</td>
      <td>.text</td>
    </tr>
    <tr>
      <td>0x70</td>
      <td>.data</td>
    </tr>
    <tr>
      <td>0xa8</td>
      <td>.bss(empty)</td>
    </tr>
    <tr>
      <td>0xa8</td>
      <td>.shstrtab</td>
    </tr>
    <tr>
      <td>0xe4</td>
      <td>Start of Section Header Table</td>
    </tr>
    <tr>
      <td>0x2e0</td>
      <td>.symtab</td>
    </tr>
    <tr>
      <td>0x3a0</td>
      <td>.strtab</td>
    </tr>
    <tr>
      <td>0x3c8</td>
      <td>.rela.text</td>
    </tr>
  </tbody>
</table>

<p>We can also see the whole file by using <code>hexdump -C max.o</code>. <code>-C</code> means Canonical hex+ASCII display.</p>

<pre><code>00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..&gt;.............|
00000020  00 00 00 00 00 00 00 00  e0 00 00 00 00 00 00 00  |................|
00000030  00 00 00 00 40 00 00 00  00 00 40 00 08 00 05 00  |....@.....@.....|
00000040  bf 00 00 00 00 67 8b 04  bd 00 00 00 00 89 c3 83  |.....g..........|
00000050  f8 00 74 12 ff c7 67 8b  04 bd 00 00 00 00 39 d8  |..t...g.......9.|
00000060  7e ed 89 c3 eb e9 b8 01  00 00 00 cd 80 00 00 00  |~...............|
00000070  03 00 00 00 43 00 00 00  22 00 00 00 16 00 00 00  |....C...".......|
00000080  2d 00 00 00 4b 00 00 00  36 00 00 00 22 00 00 00  |-...K...6..."...|
00000090  2c 00 00 00 21 00 00 00  16 00 00 00 0b 00 00 00  |,...!...........|
000000a0  42 00 00 00 00 00 00 00  00 2e 73 79 6d 74 61 62  |B.........symtab|
000000b0  00 2e 73 74 72 74 61 62  00 2e 73 68 73 74 72 74  |..strtab..shstrt|
000000c0  61 62 00 2e 72 65 6c 61  2e 74 65 78 74 00 2e 64  |ab..rela.text..d|
000000d0  61 74 61 00 2e 62 73 73  00 00 00 00 00 00 00 00  |ata..bss........|
000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000120  20 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  | ...............|
00000130  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|
00000140  2d 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |-...............|
00000150  04 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000160  1b 00 00 00 04 00 00 00  00 00 00 00 00 00 00 00  |................|
00000170  00 00 00 00 00 00 00 00  c8 03 00 00 00 00 00 00  |................|
00000180  30 00 00 00 00 00 00 00  06 00 00 00 01 00 00 00  |0...............|
00000190  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
000001a0  26 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  |&amp;...............|
000001b0  00 00 00 00 00 00 00 00  70 00 00 00 00 00 00 00  |........p.......|
000001c0  38 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |8...............|
000001d0  04 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001e0  2c 00 00 00 08 00 00 00  03 00 00 00 00 00 00 00  |,...............|
000001f0  00 00 00 00 00 00 00 00  a8 00 00 00 00 00 00 00  |................|
00000200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000210  04 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000220  11 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
00000230  00 00 00 00 00 00 00 00  a8 00 00 00 00 00 00 00  |................|
00000240  31 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |1...............|
00000250  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000260  01 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  |................|
00000270  00 00 00 00 00 00 00 00  e0 02 00 00 00 00 00 00  |................|
00000280  c0 00 00 00 00 00 00 00  07 00 00 00 07 00 00 00  |................|
00000290  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
000002a0  09 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
000002b0  00 00 00 00 00 00 00 00  a0 03 00 00 00 00 00 00  |................|
000002c0  28 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |(...............|
000002d0  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002f0  00 00 00 00 00 00 00 00  00 00 00 00 03 00 01 00  |................|
00000300  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000310  00 00 00 00 03 00 03 00  00 00 00 00 00 00 00 00  |................|
00000320  00 00 00 00 00 00 00 00  00 00 00 00 03 00 04 00  |................|
00000330  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000340  01 00 00 00 00 00 03 00  00 00 00 00 00 00 00 00  |................|
00000350  00 00 00 00 00 00 00 00  0c 00 00 00 00 00 01 00  |................|
00000360  0f 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000370  17 00 00 00 00 00 01 00  26 00 00 00 00 00 00 00  |........&amp;.......|
00000380  00 00 00 00 00 00 00 00  21 00 00 00 10 00 01 00  |........!.......|
00000390  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000003a0  00 64 61 74 61 5f 69 74  65 6d 73 00 73 74 61 72  |.data_items.star|
000003b0  74 5f 6c 6f 6f 70 00 6c  6f 6f 70 5f 65 78 69 74  |t_loop.loop_exit|
000003c0  00 5f 73 74 61 72 74 00  09 00 00 00 00 00 00 00  |._start.........|
000003d0  0b 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  |................|
000003e0  1a 00 00 00 00 00 00 00  0b 00 00 00 02 00 00 00  |................|
000003f0  00 00 00 00 00 00 00 00                           |........|
000003f8
</code></pre>

<h4 id="one-by-one-analysis-of-sections">One by one analysis of sections</h4>

<ol>
  <li><code>.shstrtab</code> stores the name of each section.</li>
  <li><code>.strtab</code> section stores the name of symbols in the program.</li>
  <li><code>.data</code> section will be loaded to the memory.</li>
  <li><code>.bss</code> section(Block Started by Symbol) stores uninitialised global variable and static variables. It will be automatically initialised to 0.</li>
  <li><code>.rel.text</code> tells the linker the relocation information.</li>
  <li><code>.symtab</code> is symbol table. We can see it in <code>readelf</code> output. <code>Value</code> is the address of the symbol, not real value. <code>GLOBAL</code>, <code>LOCAL</code> is the binding.</li>
  <li><code>.text</code> need to use <code>objdump -d max.o</code> to disassemble the program. <code>-d</code> means disassemble. It shows the program after replacing the symbol with the real address.</li>
</ol>

<hr />

<pre><code>max.o:     file format elf64-x86-64

Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   0:	bf 00 00 00 00       	mov    $0x0,%edi
   5:	67 8b 04 bd 00 00 00 	mov    0x0(,%edi,4),%eax
   c:	00 
   d:	89 c3                	mov    %eax,%ebx

000000000000000f &lt;start_loop&gt;:
   f:	83 f8 00             	cmp    $0x0,%eax
  12:	74 12                	je     26 &lt;loop_exit&gt;
  14:	ff c7                	inc    %edi
  16:	67 8b 04 bd 00 00 00 	mov    0x0(,%edi,4),%eax
  1d:	00 
  1e:	39 d8                	cmp    %ebx,%eax
  20:	7e ed                	jle    f &lt;start_loop&gt;
  22:	89 c3                	mov    %eax,%ebx
  24:	eb e9                	jmp    f &lt;start_loop&gt;

0000000000000026 &lt;loop_exit&gt;:
  26:	b8 01 00 00 00       	mov    $0x1,%eax
  2b:	cd 80                	int    $0x80
</code></pre>

<h3 id="i3-2">3.2 Executable file</h3>

<p>Previously <code>max.o</code> is the target file. <code>max</code> is the executable file.</p>

<pre><code>$ readelf -a max

ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x4000b0
  Start of program headers:          64 (bytes into file)
  Start of section headers:          320 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         2
  Size of section headers:           64 (bytes)
  Number of section headers:         6
  Section header string table index: 3

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         00000000004000b0  000000b0
       000000000000002d  0000000000000000  AX       0     0     4
  [ 2] .data             PROGBITS         00000000006000e0  000000e0
       0000000000000038  0000000000000000  WA       0     0     4
  [ 3] .shstrtab         STRTAB           0000000000000000  00000118
       0000000000000027  0000000000000000           0     0     1
  [ 4] .symtab           SYMTAB           0000000000000000  000002c0
       00000000000000f0  0000000000000018           5     6     8
  [ 5] .strtab           STRTAB           0000000000000000  000003b0
       0000000000000040  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)

There are no section groups in this file.

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000
                 0x00000000000000dd 0x00000000000000dd  R E    200000
  LOAD           0x00000000000000e0 0x00000000006000e0 0x00000000006000e0
                 0x0000000000000038 0x0000000000000038  RW     200000

 Section to Segment mapping:
  Segment Sections...
   00     .text 
   01     .data 

There is no dynamic section in this file.

There are no relocations in this file.

There are no unwind sections in this file.

Symbol table '.symtab' contains 10 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 00000000004000b0     0 SECTION LOCAL  DEFAULT    1 
     2: 00000000006000e0     0 SECTION LOCAL  DEFAULT    2 
     3: 00000000006000e0     0 NOTYPE  LOCAL  DEFAULT    2 data_items
     4: 00000000004000bf     0 NOTYPE  LOCAL  DEFAULT    1 start_loop
     5: 00000000004000d6     0 NOTYPE  LOCAL  DEFAULT    1 loop_exit
     6: 00000000004000b0     0 NOTYPE  GLOBAL DEFAULT    1 _start
     7: 0000000000600118     0 NOTYPE  GLOBAL DEFAULT  ABS __bss_start
     8: 0000000000600118     0 NOTYPE  GLOBAL DEFAULT  ABS _edata
     9: 0000000000600118     0 NOTYPE  GLOBAL DEFAULT  ABS _end

No version information found in this file.
</code></pre>

<p>In ELF Header, <code>Type</code> is <code>EXEC</code>, <code>entry point address</code> is changed( it is the <code>_start</code> address).</p>

<p>Let’s see the disassembled code.</p>

<pre><code>$ objdump -d max

max:     file format elf64-x86-64


Disassembly of section .text:

00000000004000b0 &lt;_start&gt;:
  4000b0:	bf 00 00 00 00       	mov    $0x0,%edi
  4000b5:	67 8b 04 bd e0 00 60 	mov    0x6000e0(,%edi,4),%eax
  4000bc:	00 
  4000bd:	89 c3                	mov    %eax,%ebx

00000000004000bf &lt;start_loop&gt;:
  4000bf:	83 f8 00             	cmp    $0x0,%eax
  4000c2:	74 12                	je     4000d6 &lt;loop_exit&gt;
  4000c4:	ff c7                	inc    %edi
  4000c6:	67 8b 04 bd e0 00 60 	mov    0x6000e0(,%edi,4),%eax
  4000cd:	00 
  4000ce:	39 d8                	cmp    %ebx,%eax
  4000d0:	7e ed                	jle    4000bf &lt;start_loop&gt;
  4000d2:	89 c3                	mov    %eax,%ebx
  4000d4:	eb e9                	jmp    4000bf &lt;start_loop&gt;

00000000004000d6 &lt;loop_exit&gt;:
  4000d6:	b8 01 00 00 00       	mov    $0x1,%eax
  4000db:	cd 80                	int    $0x80
</code></pre>

<p>The relative addresses in target file have been replaced with absolute address.</p>

<p>In target file, it has: </p>

<pre><code>5:	67 8b 04 bd 00 00 00 	mov    0x0(,%edi,4),%eax
</code></pre>

<p>Now become:</p>

<pre><code>4000b5:	67 8b 04 bd e0 00 60 	mov    0x6000e0(,%edi,4),%eax
</code></pre>

<p>How does the linker know to change <code>0x0</code> to <code>0x6000e0</code>? It is based on the <code>.rela.text</code> section.</p>

<pre><code>Relocation section '.rela.text' at offset 0x3c8 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000009  00020000000b R_X86_64_32S      0000000000000000 .data + 0
00000000001a  00020000000b R_X86_64_32S      0000000000000000 .data + 0
</code></pre>

            
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="C Essense (1) - x86 Assembly Programming Basic" data-related="allenlsy">Tweet</a>
    </div>
    
    
    <div>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
    
    
    <div>
        <div class="g-plusone" data-size="medium"></div>
    </div>
    
    
    
    <div>
        <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
    </div>
    
</div>

        </section>
        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'allenlsy'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
        <section>
            <h3>中文评论区</h3>
            <div id="duoshuo_thread" class="ds-thread"></div>
<!-- Duoshuo Comment BEGIN -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"allenlsy21"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
<!-- Duoshuo Comment END -->

        </section>
    </div>
</article>


<footer class="site-footer">
    <div class="container">
      copy; 2014 &nbsp; 

        <nav>
            <a href="http://allenlsy.com">Blog</a> &middot;
            <a href="http://cast.allenlsy.com">Casts</a> &middot;
            
            
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/allenlsy" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/allenlsy" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
            
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24647338-1', '');
  ga('send', 'pageview');
</script>

</body>
</html>
