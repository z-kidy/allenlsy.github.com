<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working with Unix Process in Ruby &mdash; Simple, Not Easy</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700,800|Oswald|PT+Mono|Ubuntu+Mono" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.jpg"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Simple, Not Easy" />
    <meta name="title" content="Working with Unix Process in Ruby ">
    <link rel="canonical" href="/working-with-unix-process-in-ruby">
    
    <link rel="author" href="https://plus.google.com/118230970865161551961">
    <meta property="og:title" content="Working with Unix Process in Ruby "/>
    <meta property="og:url" content="/working-with-unix-process-in-ruby"/>
     
    
    <meta property="og:description" content="NOTES of Working with Unix Process in Ruby, by Jesse Storimer"/>
    <meta name="description" content="NOTES of Working with Unix Process in Ruby, by Jesse Storimer"/>
    
    <meta property="og:site_name" content="Simple, Not Easy">
    <link rel="stylesheet" href="/bt-responsive.css" type="text/css" media="screen" charset="utf-8">
    <meta name="keywords" content="book,ruby,process,unix">
</head>
<body>

<section class="site-nav">
    <header>
        <nav id="navigation" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
            <a class="brand" href="/">
                <img src="/images/logo.jpg" alt="Inc">
            </a>
            <a href="/">Blog</a>
            
              <a href="/archives.html" >Archives</a>
            
              <a href="/about.html" >About</a>
            
              <a href="/tags.html" >Tags</a>
            
              <a href="http://cast.allenlsy.com" >Casts</a>
            
              <a href="/galleries.html" >Galleries</a>
            
            <i class="icon-feed"></i> <a href="/feed.xml" title="Atom/RSS feed">Feed</a>
        </nav>

    </header>
</section>


<article>

    <div class="container">
        <header>
            <h1 class="title">Working with Unix Process in Ruby</h1>
            
            <div class="meta">
                <time pubdate datetime="2014-09-January" title="January 09, 2014">January 09, 2014</time>
            </div>
            <div class="tags">
              <a href="/tags/book.html" rel="tag">book</a> <a href="/tags/ruby.html" rel="tag">ruby</a> <a href="/tags/process.html" rel="tag">process</a> <a href="/tags/unix.html" rel="tag">unix</a>
            </div>
            <div class="hidden-seo">
              By <a href="/working-with-unix-process-in-ruby" title="Working with Unix Process in Ruby" rel="author">allenlsy</a>
            </div>
        </header>

        <section class="article">
            <p><img src="http://rayhightower.com/images/working-w-unix-processes.jpg" alt="" /></p>

<p><a href="http://www.jstorimer.com/products/working-with-unix-processes">Book home page</a></p>

<h2 id="reference-of-ruby-process-related-methods">Reference of Ruby Process related methods</h2>

<table>
  <thead>
    <tr>
      <th>Ruby Library Method</th>
      <th>Unix System Method</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Process.pid</code></td>
      <td><code>getpid</code></td>
      <td>get calling process identification</td>
    </tr>
    <tr>
      <td><code>Process.ppid</code></td>
      <td><code>getppid</code></td>
      <td>get parent process identification</td>
    </tr>
    <tr>
      <td><code>IO#fileno</code></td>
      <td> </td>
      <td>get file descriptor number</td>
    </tr>
    <tr>
      <td><code>Process.getrlimit</code></td>
      <td><code>getrlimit</code></td>
      <td>get system resource limit</td>
    </tr>
    <tr>
      <td><code>Process.setrlimit</code></td>
      <td><code>setrlimit</code></td>
      <td>set system resource limit</td>
    </tr>
    <tr>
      <td>-</td>
      <td><code>setenv</code></td>
      <td>set environment variable</td>
    </tr>
    <tr>
      <td>-</td>
      <td><code>getenv</code></td>
      <td>get environment variable value</td>
    </tr>
    <tr>
      <td><code>Kernel#exit</code></td>
      <td><code>exit</code></td>
      <td>exit program</td>
    </tr>
    <tr>
      <td><code>Kernel#abort</code></td>
      <td> </td>
      <td>exit, and message print to STDERR</td>
    </tr>
    <tr>
      <td><code>Kernel#raise</code></td>
      <td> </td>
      <td>like <code>raise</code> in ruby, look for exception handling. Exit if not found.</td>
    </tr>
    <tr>
      <td><code>Kernel#fork</code></td>
      <td><code>fork</code></td>
      <td> </td>
    </tr>
    <tr>
      <td><code>Process#wait</code></td>
      <td><code>waitpid</code></td>
      <td>wait until one of the child processes exit</td>
    </tr>
    <tr>
      <td><code>Process#wait2</code></td>
      <td><code>waitpid</code></td>
      <td>returns (pid, status)</td>
    </tr>
    <tr>
      <td><code>Process#waitpid</code></td>
      <td><code>waitpid</code></td>
      <td>Ruby: wait for process</td>
    </tr>
    <tr>
      <td><code>Process#waitpid2</code></td>
      <td><code>waitpid</code></td>
      <td>Ruby: wait for process, returns</td>
    </tr>
    <tr>
      <td><code>Process#detach</code></td>
      <td>-</td>
      <td>create a new process, only to wait for a centain process to end</td>
    </tr>
    <tr>
      <td><code>Process#kill</code></td>
      <td><code>kill</code></td>
      <td> </td>
    </tr>
    <tr>
      <td><code>Process#trap</code></td>
      <td><code>sigaction</code></td>
      <td>define signal handling function</td>
    </tr>
    <tr>
      <td><code>IO.pipe</code></td>
      <td><code>pipe</code></td>
      <td>define new pipe</td>
    </tr>
    <tr>
      <td><code>Socket.pair</code></td>
      <td><code>socketpair</code></td>
      <td>define pair of sockets</td>
    </tr>
    <tr>
      <td><code>Socket.recv</code></td>
      <td><code>recv</code></td>
      <td>sockets receive</td>
    </tr>
    <tr>
      <td><code>Socket.send</code></td>
      <td><code>send</code></td>
      <td>sockets send</td>
    </tr>
    <tr>
      <td><code>Process.setsid</code></td>
      <td><code>getsid</code></td>
      <td>create new session group</td>
    </tr>
    <tr>
      <td><code>Process.getpgrp</code></td>
      <td><code>getpgrp</code></td>
      <td>get process group id</td>
    </tr>
  </tbody>
</table>

<h1 id="basic-of-process">1. Basic of Process</h1>

<ul>
  <li>Get process descriptor in shell: <code>$$</code></li>
  <li>In Unix, everything is FILE. Every file gets a descriptor</li>
  <li>Get process name in ruby: <code>$PROGRAM_NAME</code></li>
</ul>

<h4 id="file-descriptor">File descriptor</h4>

<ol>
  <li>File descriptor number is resuable</li>
  <li>STDIN, STDOUT, STDERR is predefined</li>
</ol>

<div class="highlight"><pre><code class="ruby"><span class="nb">puts</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">fileno</span> 	<span class="c1"># =&gt; 0</span>
<span class="nb">puts</span> <span class="no">STDOUT</span><span class="o">.</span><span class="n">fileno</span> 	<span class="c1"># =&gt; 1</span>
<span class="nb">puts</span> <span class="no">STDERR</span><span class="o">.</span><span class="n">fileno</span> 	<span class="c1"># =&gt; 2</span>
</code></pre></div>

<h4 id="io-library-in-ruby"><code>IO</code> library in Ruby</h4>

<p><code>open</code>, <code>close</code>, <code>read</code>, <code>write</code>, <code>pipe</code>, <code>fsync</code>, <code>stat</code></p>

<h4 id="resource-limitation-of-process">Resource Limitation of Process</h4>

<p>Maximum file descriptor number: <code>p Process.getrlimit(:NOFILE) # =&gt; [2560, 9223372036854775807]</code></p>

<p>2560 is <strong>Soft limitation</strong>. To change the sofr limitation, eg. <code>Process.setrlimit(:NOFILE, 4096)</code>. Third argument of this method can set hard limitation. It is not reversable.</p>

<h4 id="environment-and-arguments">Environment and arguments</h4>

<ul>
  <li><code>ENV</code>: get environment argument into an array in Ruby</li>
  <li><code>ARGV</code>: get arguments from the command line into an array in Ruby</li>
</ul>

<p>A ruby library <code>optparse</code> is used for parsing command line options.</p>

<h4 id="exit-code">Exit code</h4>

<p><code>exit</code>, <code>abort</code>, <code>raise</code></p>

<h3 id="examples-of-process-basic">Examples of process basic</h3>

<div class="highlight"><pre><code class="ruby"><span class="c1"># IO#fileno</span>
<span class="n">passwd</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/etc/passwd&#39;</span> <span class="p">)</span>
<span class="nb">puts</span> <span class="n">passwd</span><span class="o">.</span><span class="n">fileno</span>

<span class="c1"># Resource limitations</span>
<span class="no">Process</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="ss">:NPROC</span> <span class="p">)</span>
<span class="no">Process</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="ss">:FSIZE</span> <span class="p">)</span>
<span class="no">Process</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="ss">:STACK</span> <span class="p">)</span>
</code></pre></div>

<h1 id="multiple-processes-fork">2. Multiple processes: <code>fork</code></h1>

<p>Child process will inherit the whole memory of parent process. To improve performance, memory uses <em>copy-on-write</em> strategy.</p>

<p><strong>IMPORTANT</strong>: <code>fork</code> returns <code>nil</code> in child process, returns the pid of child process in parent process.</p>

<h3 id="process-wait">Process Wait</h3>

<p><code>Process#wait</code>, <code>Process#wait2</code>, <code>Process#waitpid</code>, <code>Process#waitpid2</code></p>

<p><code>wait</code> and <code>waitpid</code> are actually the same. They accepts the same type of arguments, and behave the same.</p>

<p>Pass argument <code>-1</code> to <code>wait</code> will wait for any child process.</p>

<p>If there is no child process, <code>Process.wait</code> will throw <code>Errno::ECHILD</code> exception.</p>

<h3 id="zombie-process">Zombie process</h3>

<p>The kernel will retain the status of exited child processes until the parent process requests that status using <code>Process.wait</code>. If the parent never requests the status then the kernel can never return that status information.</p>

<p><code>Process.detach</code> will create a process wating for specified child process to exit.</p>

<p>Using <code>ps</code> to check process, zombie process will be marked <code>z</code> or <code>Z+</code></p>

<h3 id="code-example-of-fork">Code example of <code>fork</code></h3>

<div class="highlight"><pre><code class="ruby"><span class="c1"># Fork a process</span>
<span class="k">if</span> <span class="nb">fork</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">else</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
<span class="c1"># or</span>
<span class="nb">fork</span> <span class="k">do</span> 
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>

<span class="c1"># wait2</span>
<span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="no">Process</span><span class="o">.</span><span class="n">wait2</span>

<span class="c1"># waitpid2</span>
<span class="n">favorite</span> <span class="o">=</span> <span class="nb">fork</span> <span class="k">do</span><span class="p">;</span> <span class="nb">exit</span> <span class="mi">77</span><span class="p">;</span> <span class="k">end</span>
<span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="no">Process</span><span class="o">.</span><span class="n">waitpid2</span> <span class="n">favorite</span>
<span class="nb">puts</span> <span class="n">status</span><span class="o">.</span><span class="n">exitstatus</span>	

<span class="c1"># zombie process</span>
<span class="n">pid</span> <span class="o">=</span> <span class="nb">fork</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
<span class="no">Process</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</code></pre></div>

<h1 id="signal">3. Signal</h1>

<p><code>wait</code> is a <strong>blocking method</strong>: until child process exit, the method returns.</p>

<p>Catching signal is non-blocking.</p>

<p>Signal delivering is not reliable. </p>

<p>We suggest using <code>Process.wait</code> to deal with signal. </p>

<pre><code>Process.wait(-1, Process::WNOHANG)
</code></pre>

<p><code>Process::WNOHANG</code> means, if no child process exit, then do not block.</p>

<h4 id="catch-signal">Catch signal</h4>

<h4 id="send-signal">Send signal</h4>

<pre><code>Process.kill(:INT, pid_of_a_process)
</code></pre>

<h4 id="re-define-signal-handling-process">Re-define signal handling process</h4>

<pre><code>trap(:INT) { ... }
</code></pre>

<p>But some of the signal handling cannot be re-defined.</p>

<p><code>INT</code> is actually <code>Ctrl+C</code>, which is not as powerful as <code>KILL</code>.</p>

<h4 id="re-define-signal-propertly">Re-define signal propertly</h4>

<p><strong>Notice</strong> to Keep system default handling</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s1">&#39;This is the first signal handler&#39;</span> <span class="p">}</span>
<span class="n">old_handler</span> <span class="o">=</span> <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">old_handler</span><span class="o">.</span><span class="n">call</span>
  <span class="nb">puts</span> <span class="s1">&#39;This is the second handler&#39;</span>
  <span class="nb">exit</span>
<span class="p">}</span>
<span class="nb">sleep</span>
</code></pre></div>

<p>Also we can use <code>at_exit</code> hook.</p>

<h3 id="example-of-signal">Example of Signal</h3>

<div class="highlight"><pre><code class="ruby"><span class="c1"># catch SIGCHLD</span>
<span class="nb">trap</span><span class="p">(</span><span class="ss">:CHLD</span><span class="p">)</span> <span class="k">do</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>

<span class="c1"># Full example</span>
<span class="n">child_processes</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">dead_processes</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">child_processes</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
  <span class="nb">fork</span> <span class="k">do</span>
    <span class="nb">sleep</span> <span class="mi">3</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># To ensure CHLD will not call flush for #puts call</span>
<span class="vg">$stdout</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="kp">true</span>

<span class="nb">trap</span><span class="p">(</span><span class="ss">:CHLD</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">begin</span>
    <span class="k">while</span> <span class="n">pid</span> <span class="o">=</span> <span class="no">Process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="no">Process</span><span class="o">::</span><span class="no">WNOHANG</span><span class="p">)</span>
      <span class="nb">puts</span> <span class="n">pid</span>
	  <span class="n">dead_processes</span> <span class="o">+=</span> <span class="mi">1</span>
	  <span class="nb">exit</span> <span class="k">if</span> <span class="n">dead_processes</span> <span class="o">==</span> <span class="n">child_processes</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ECHILD</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kp">loop</span> <span class="k">do</span>
  <span class="p">(</span><span class="no">Math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">44</span><span class="p">))</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span>
  <span class="nb">sleep</span> <span class="mi">1</span>
<span class="k">end</span>
</code></pre></div>

<h1 id="pipe">4. Pipe</h1>

<p>Pipe is a single direction data stream.</p>

<h4 id="shared-pipe-in-multi-processes">Shared pipe in multi-processes</h4>

<p><code>IO</code> operations: <code>read</code>, <code>write</code>, <code>close</code>, <code>gets</code>, <code>puts</code></p>

<p>Stream is endless. It has protocol specified <em>delimeter</em> to define <em>chunks</em>. <code>gets</code>, <code>puts</code> can R/W a string seperated by <code>newline</code> sign. <code>newline</code> is a delimeter.</p>

<p>IPC (Inter-process communication) uses <em>sockets</em>, rather than TCP, because sockets is faster in IPC.</p>

<p>Sockets uses <em>datagram</em> to communicate rather than stream. Datagram is a full piece of message, not using delimeter.</p>

<h3 id="example-of-pipe">Example of Pipe</h3>

<div class="highlight"><pre><code class="ruby"><span class="n">reader</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">pipe</span>

<span class="c1"># basic communication</span>
<span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">pipe</span>
<span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Into the pipe I go...&quot;</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span> <span class="c1"># close unused stream endpoint</span>
<span class="nb">puts</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span>

<span class="c1"># shared pipe</span>
<span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">pipe</span>
<span class="nb">fork</span> <span class="k">do</span>
  <span class="n">reader</span><span class="o">.</span><span class="n">close</span>
<span class="mi">10</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
<span class="n">writer</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Another one bites the dust&quot;</span>
<span class="k">end</span> <span class="k">end</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span>
<span class="k">while</span> <span class="n">message</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">gets</span>
  <span class="vg">$stdout</span><span class="o">.</span><span class="n">puts</span> <span class="n">message</span>
<span class="k">end</span>

<span class="c1"># Sockets</span>
<span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>
<span class="no">Socket</span><span class="o">.</span><span class="n">pair</span><span class="p">(</span><span class="ss">:UNIX</span><span class="p">,</span> <span class="ss">:DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#=&gt; [#&lt;Socket:fd 15&gt;, #&lt;Socket:fd 16&gt;]</span>

<span class="c1"># Full example of sockets</span>
<span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>
<span class="n">child_socket</span><span class="p">,</span> <span class="n">parent_socket</span> <span class="o">=</span> <span class="no">Socket</span><span class="o">.</span><span class="n">pair</span><span class="p">(</span><span class="ss">:UNIX</span><span class="p">,</span> <span class="ss">:DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">maxlen</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="nb">fork</span> <span class="k">do</span>
  <span class="n">parent_socket</span><span class="o">.</span><span class="n">close</span>
  <span class="mi">4</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">child_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">maxlen</span><span class="p">)</span>
    <span class="n">child_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">instruction</span><span class="si">}</span><span class="s2"> accomplished!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">end</span> <span class="k">end</span>
<span class="n">child_socket</span><span class="o">.</span><span class="n">close</span>
<span class="mi">2</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
  <span class="n">parent_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Heavy lifting&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>
<span class="mi">2</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
  <span class="n">parent_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Feather lifting&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>
<span class="mi">4</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
  <span class="vg">$stdout</span><span class="o">.</span><span class="n">puts</span> <span class="n">parent_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">maxlen</span><span class="p">)</span>	
<span class="k">end</span>

<span class="c1"># OUTPUT</span>
<span class="c1"># Heavy lifting accomplished!</span>
<span class="c1"># Heavy lifting accomplished!</span>
<span class="c1"># Feather lifting accomplished!</span>
<span class="c1"># Feather lifting accomplished!</span>
</code></pre></div>

<h1 id="daemon-process">5. Daemon Process</h1>

<p>Daemon process normally won’t stop by itself.</p>

<p>When system boots, there is a <code>init</code> process, whose ppid is <strong>0</strong>. It is the ancestor of all processes.</p>

<h4 id="create-a-daemon-process">Create a daemon process</h4>

<p><code>exit if fork</code> or <code>Process.daemon</code>. In parent process, it returns the pid of child, which leads to exit.</p>

<p>After parent exit, the <code>ppid</code> of orphan process is always <strong>1</strong>.</p>

<h4 id="process-group--session-group">Process group &amp; Session group</h4>

<p>Use <code>Process.setpgrp(new_group_id)</code> to set process group.</p>

<p>Process group id is the pid of the group leader process.</p>

<p>A child process has the same process group id as the parent process.</p>

<p>Terminal receives signal, and dispatches to every child processes in this process group.</p>

<p><strong>Session group</strong> is a set of process groups.</p>

<pre><code>git log | grep shipped | less
</code></pre>

<p>In this example, every sub-command has its own process group. They all belongs to the same session group.</p>

<p>When signal comes to the leader of the session group, it passes the signal to all the leaders of the process groups inside, and the leaders pass the signal again to processes in the process group.</p>

<p>Hierarchical signal passing.</p>

<p><code>Process.setsid</code> to get session group id. It can also fork a new process group and a new leader of session group.</p>

<p>After that if we run <code>exit if fork</code>, the new session group leader will leave the control of terminal. The new session group can be used as daemon processes.</p>

<p>Also set the streams of the process to <code>/dev/null</code>.</p>

<pre><code>STDIN.reopen "/dev/null"
STDOUT.reopen "/dev/null", "a"
STDERR.reopen "/dev/null", "a"
</code></pre>

<h3 id="examples-of-daemon-process">Examples of daemon process</h3>

<div class="highlight"><pre><code class="ruby"><span class="c1"># process group id</span>
<span class="nb">puts</span> <span class="no">Process</span><span class="o">.</span><span class="n">pid</span>
<span class="nb">puts</span> <span class="no">Process</span><span class="o">.</span><span class="n">getpgrp</span>
<span class="nb">fork</span> <span class="p">{</span>
  <span class="nb">puts</span> <span class="no">Process</span><span class="o">.</span><span class="n">pid</span>
  <span class="nb">puts</span> <span class="no">Process</span><span class="o">.</span><span class="n">getpgrp</span>
<span class="p">}</span>
</code></pre></div>

<h1 id="spawning-terminal-process">6. Spawning terminal process</h1>

<p><code>exec</code> command can convert current process to another process, unrevertable.</p>

<p>Use <code>fork + exec</code> to spawn new process. <code>exec</code> cannot convert a process back. But with <code>fork</code> can maintain a unconverted copy of process.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">hosts</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/etc/hosts&#39;</span><span class="p">)</span>
<span class="nb">exec</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s2">&quot;import os; print os.fdopen(</span><span class="si">#{</span><span class="n">hosts</span><span class="o">.</span><span class="n">fileno</span><span class="si">}</span><span class="s2">).read()&quot;</span>
</code></pre></div>

<p><code>exec</code> runs a shell command actually. </p>

<p><code>Kernel#system</code> runs shell command, and returns the terminal exit code.</p>

<p><code>Kernel#`</code> returns the STDOUT string. Same as <code>%x[]</code></p>

<div class="highlight"><pre><code class="ruby"><span class="sb">`ls`</span>
<span class="sb">`ls --help`</span>
<span class="sx">%x[git log | tail -10]</span>
</code></pre></div>

<p><code>Process.spawn</code> is a non-blocking call.</p>

<h4 id="iopopen"><code>IO.popen</code></h4>

<p><code>popen</code> opens a pipe, returns file descriptor number.</p>

<h4 id="ioopen3"><code>IO.open3</code></h4>

<p>Opens STDIN, STDOUT, STDERR at the same time.</p>

<h4 id="last-word-about-fork">Last word about <code>fork</code></h4>

<p><code>fork</code> consumes a lot of memory. Some system call have optimization. Original Ruby library does not support system call, but <code>posix-spawn</code> project supports.</p>

<h3 id="example-of-spawn">Example of spawn</h3>

<div class="highlight"><pre><code class="ruby"><span class="no">Process</span><span class="o">.</span><span class="n">spawn</span><span class="p">({</span><span class="s1">&#39;RAILS_ENV&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">},</span> <span class="s1">&#39;rails server&#39;</span><span class="p">)</span>
<span class="no">Process</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;--help&#39;</span><span class="p">,</span> <span class="no">STDERR</span> <span class="o">=&gt;</span> <span class="no">STDOUT</span><span class="p">)</span>

<span class="c1"># example of popen</span>
<span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;less&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">stream</span><span class="o">|</span>
  <span class="n">stream</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;some</span><span class="se">\n</span><span class="s2">data&quot;</span>
<span class="p">}</span>

<span class="c1"># example of open3</span>

<span class="nb">require</span> <span class="s1">&#39;open3&#39;</span>
<span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;grep&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">|</span>
  <span class="n">stdin</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;some</span><span class="se">\n</span><span class="s2">data&quot;</span>
  <span class="n">stdin</span><span class="o">.</span><span class="n">close</span>
  <span class="nb">puts</span> <span class="n">stdout</span><span class="o">.</span><span class="n">read</span>
<span class="p">}</span>
<span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;-uhh&#39;</span><span class="p">,</span> <span class="ss">:err</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">stdout</span><span class="o">.</span><span class="n">read</span>
<span class="p">}</span>
</code></pre></div>


        </section>
        <section class="article">
          <hr>
          <h4>Share this article</h4>
          
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Working with Unix Process in Ruby" data-related="allenlsy">Tweet</a>
    </div>
    
    
    <div>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
    
    
    <div>
        <div class="g-plusone" data-size="medium"></div>
    </div>
    
    
    
    <div>
        <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
    </div>
    
</div>

        </section>
        <section class="row">
          <hr>
          <div class="col-md-6">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'allenlsy'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
          </div>
          <div class="col-md-6">
            <div id="duoshuo_thread" class="ds-thread"></div>
<!-- Duoshuo Comment BEGIN -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"allenlsy21"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
<!-- Duoshuo Comment END -->

          </div>
        </section>
    </div>
</article>


<footer class="site-footer">
    <div class="container">
      copy; 2014 &nbsp; 

        <nav>
            <a href="http://allenlsy.com">Blog</a> &middot;
            <a href="http://cast.allenlsy.com">Casts</a> &middot;
            
            
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/allenlsy" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/allenlsy" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
            
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24647338-1', '');
  ga('send', 'pageview');
</script>




</body>
</html>
